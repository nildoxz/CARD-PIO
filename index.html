<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedido Online - SABOR A√áA√çTERIA</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-body::-webkit-scrollbar {
            width: 8px;
        }
        .modal-body::-webkit-scrollbar-track {
            background: #1f2937;
            border-radius: 10px;
        }
        .modal-body::-webkit-scrollbar-thumb {
            background: #581c87;
            border-radius: 10px;
        }
        .modal-body::-webkit-scrollbar-thumb:hover {
            background: #6b21a8;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        input[type="checkbox"]:disabled + span {
            color: #6b7280;
            cursor: not-allowed;
        }
        .alert-modal {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        input[type="radio"]:checked + div > .radio-title {
            color: #c084fc;
        }
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(0.8);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-300">

    <div class="container mx-auto p-4 sm:p-8 max-w-4xl">
        <!-- Header Section -->
        <header class="text-center mb-8 p-6 rounded-2xl bg-gradient-to-tr from-black to-gray-800 text-white shadow-lg">
            <h1 class="text-5xl md:text-6xl font-black tracking-tight text-amber-400">SABOR A√áA√çTERIA</h1>
            <p class="text-lg md:text-xl mt-2 text-gray-300 opacity-90">Monte seu pedido online de forma f√°cil e r√°pida!</p>
            <p id="store-hours-display" class="text-md md:text-lg mt-3 text-gray-300 opacity-90 bg-white/10 rounded-full px-4 py-1 inline-flex items-center justify-center">
                <i class="fas fa-clock mr-2"></i> <span>Carregando hor√°rio...</span>
                <span id="store-status-indicator" class="ml-2 px-3 py-1 text-sm rounded-full"></span>
            </p>
        </header>

        <!-- Store Status Banner -->
        <div id="store-status-banner" class="hidden"></div>

        <main class="space-y-8">
            <!-- Products Section -->
            <section id="tamanhos" class="bg-gray-800 p-6 rounded-2xl shadow-md">
                <h2 class="text-3xl font-bold text-purple-400 mb-4 border-b-2 border-purple-800 pb-2">Escolha o Tamanho</h2>
                <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Products will be dynamically injected by JavaScript -->
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="text-center mt-10 space-y-4">
            <div class="bg-gray-800 p-4 rounded-2xl shadow-md border-2 border-gray-700">
                 <h3 class="text-lg font-bold text-purple-400 mb-2 flex items-center justify-center gap-2">
                    <i class="fas fa-map-marker-alt"></i>
                    Nosso Endere√ßo
                </h3>
                 <p id="store-address-display" class="text-gray-300 text-base">
                    Carregando endere√ßo...
                </p>
            </div>
            <div class="text-gray-400 pt-2">
                <p>Siga-nos no Instagram: 
                    <a href="https://www.instagram.com/sabor_acaiteria_delivery/profilecard/?igsh=NjF2ZWMwNHNiNzI0" target="_blank" class="font-semibold text-purple-400 hover:underline">@sabor_acaiteria_delivery</a>
                </p>
            </div>
            <!-- Admin Panel Button -->
            <div class="mt-6">
                 <a href="#" id="admin-panel-btn" class="inline-block bg-amber-400 text-gray-900 font-bold py-3 px-6 rounded-lg hover:bg-amber-500 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                    <i class="fas fa-user-shield mr-2"></i>Painel do Administrador
                </a>
            </div>
        </footer>
    </div>

    <!-- Floating WhatsApp Button -->
    <a id="whatsapp-link" href="#" target="_blank" class="fixed bottom-5 left-5 z-50">
        <button class="bg-green-500 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center hover:bg-green-600 transition-transform transform hover:scale-110">
            <i class="fab fa-whatsapp text-3xl"></i>
        </button>
    </a>

    <!-- Floating Cart Button -->
    <div id="cart-button" class="fixed bottom-5 right-5 z-50 hidden">
        <button id="toggle-cart-btn" class="bg-purple-600 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center hover:bg-purple-700 transition-transform transform hover:scale-110">
            <i class="fas fa-shopping-cart text-2xl"></i>
            <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center">0</span>
        </button>
    </div>

    <!-- Item Customization Modal -->
    <div id="item-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4">
        <div class="bg-gray-800 text-gray-200 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 id="modal-title" class="text-2xl font-bold text-purple-400">Monte seu A√ßa√≠</h3>
                <button id="close-item-modal-btn" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <div id="modal-body" class="p-6 space-y-6 overflow-y-auto modal-body">
                <!-- Toppings will be dynamically injected by JavaScript -->
            </div>
            <div class="p-4 bg-gray-900 border-t border-gray-700 flex justify-between items-center">
                <div>
                    <span class="text-lg font-medium text-gray-300">Total do Item:</span>
                    <span id="modal-item-total" class="text-2xl font-bold text-purple-400 ml-2">R$ 0,00</span>
                </div>
                <button id="add-to-cart-btn" class="bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition-all flex items-center gap-2">
                    <i class="fas fa-cart-plus"></i> Adicionar ao Carrinho
                </button>
            </div>
        </div>
    </div>

    <!-- Cart and Checkout Modal -->
    <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4">
         <div class="bg-gray-800 text-gray-200 rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-2xl font-bold text-purple-400">Seu Carrinho e Pedido</h3>
                <button id="close-cart-modal-btn" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <div class="p-6 space-y-6 overflow-y-auto modal-body">
                <div id="cart-items-container"></div>
                <div id="cart-summary-details" class="pt-4 mt-4 border-t border-gray-700 space-y-2 hidden">
                     <div class="flex justify-between text-gray-400">
                         <span>Subtotal</span>
                         <span id="cart-subtotal">R$ 0,00</span>
                     </div>
                     <div class="flex justify-between text-gray-400">
                         <span>Taxa de Entrega</span>
                         <span id="cart-delivery-fee">R$ 0,00</span>
                     </div>
                </div>
                <div id="checkout-form" class="space-y-4 pt-6 border-t border-gray-700 hidden">
                    <h4 class="text-xl font-bold text-gray-200">Informa√ß√µes do Pedido</h4>
                    <div id="delivery-options">
                        <div class="flex flex-col sm:flex-row gap-4">
                            <label id="delivery-option-delivery" class="flex-1 flex items-center p-3 border-2 border-gray-600 rounded-lg cursor-pointer has-[:checked]:border-purple-500 has-[:checked]:bg-purple-900/50">
                                <input type="radio" name="delivery_option" value="delivery" class="hidden" checked>
                                <div class="flex items-center">
                                    <span class="mr-3"><i class="fas fa-motorcycle text-xl text-purple-400"></i></span>
                                    <div><span class="font-semibold text-gray-300 block radio-title">Delivery (Entrega)</span><span class="text-sm text-gray-500">20-60 min</span></div>
                                </div>
                            </label>
                            <label id="delivery-option-takeout" class="flex-1 flex items-center p-3 border-2 border-gray-600 rounded-lg cursor-pointer has-[:checked]:border-purple-500 has-[:checked]:bg-purple-900/50">
                                <input type="radio" name="delivery_option" value="takeout" class="hidden">
                                <div class="flex items-center">
                                    <span class="mr-3"><i class="fas fa-store text-xl text-purple-400"></i></span>
                                    <div><span class="font-semibold text-gray-300 block radio-title">Retirar na Loja</span><span class="text-sm text-gray-500">20-30 min</span></div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div>
                        <label for="customer-name" class="block text-sm font-medium text-gray-400">Seu Nome</label>
                        <input type="text" id="customer-name" class="mt-1 block w-full bg-gray-700 border-2 border-gray-600 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 p-3 text-base" required>
                    </div>
                    <div id="delivery-fields" class="space-y-4">
                         <div>
                            <label for="neighborhood" class="block text-sm font-medium text-gray-400">Selecione o Bairro</label>
                            <select id="neighborhood" class="mt-1 block w-full bg-gray-700 border-2 border-gray-600 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 p-3 text-base">
                                <option value="" data-fee="0">-- Escolha uma op√ß√£o --</option>
                                <option value="Jardim Europa" data-fee="7.00">Jardim Europa (R$ 7,00)</option>
                                <option value="Amec" data-fee="7.00">Amec (R$ 7,00)</option>
                                <option value="Vale dos Sonhos 1 e 2" data-fee="8.00">Vale dos Sonhos 1 e 2 (R$ 8,00)</option>
                                <option value="Jardim do Lago" data-fee="8.00">Jardim do Lago (R$ 8,00)</option>
                                <option value="Casas Populares" data-fee="9.00">Casas Populares (R$ 9,00)</option>
                                <option value="Nova Esperan√ßa 2" data-fee="9.00">Nova Esperan√ßa 2 (R$ 9,00)</option>
                                <option value="Outro Bairro" data-fee="6.00">Outro Bairro (Taxa Padr√£o R$ 6,00)</option>
                            </select>
                        </div>
                        <div>
                            <label for="customer-address" class="block text-sm font-medium text-gray-400">Endere√ßo Completo (Rua, N√∫mero, Complemento)</label>
                            <input type="text" id="customer-address" class="mt-1 block w-full bg-gray-700 border-2 border-gray-600 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 p-3 text-base" placeholder="Ex: Rua das Flores, 123, apt 4" required>
                        </div>
                    </div>
                     <div>
                        <label for="payment-method" class="block text-sm font-medium text-gray-400">Forma de Pagamento</label>
                        <select id="payment-method" class="mt-1 block w-full bg-gray-700 border-2 border-gray-600 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 p-3 text-base">
                            <option>Pix</option>
                            <option>Cart√£o de Cr√©dito (na entrega)</option>
                            <option>Cart√£o de D√©bito (na entrega)</option>
                            <option>Dinheiro</option>
                        </select>
                        <p class="text-xs text-yellow-400 mt-2"><i class="fas fa-info-circle mr-1"></i>Observa√ß√£o: n√£o aceitamos VR e vales refei√ß√£o no momento.</p>
                    </div>
                     <div>
                        <label for="observations" class="block text-sm font-medium text-gray-400">Observa√ß√µes</label>
                        <textarea id="observations" rows="3" class="mt-1 block w-full bg-gray-700 border-2 border-gray-600 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 p-3 text-base" placeholder="Ex: Troco para R$50, sem cebola, etc."></textarea>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-gray-900 border-t border-gray-700 flex justify-between items-center">
                 <div>
                    <span class="text-lg font-medium text-gray-300">Total do Pedido:</span>
                    <span id="cart-total" class="text-2xl font-bold text-purple-400 ml-2">R$ 0,00</span>
                </div>
                <button id="finalize-order-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-all flex items-center gap-2">
                    <i class="fab fa-whatsapp"></i> Finalizar Pedido
                </button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center p-4">
        <div class="bg-gray-800 text-gray-200 rounded-2xl shadow-2xl w-full max-w-lg text-center p-8">
            <div id="confirmation-icon"><i class="fas fa-check-circle text-green-500 text-6xl mb-4"></i></div>
            <h3 id="confirmation-title" class="text-2xl font-bold text-gray-100 mb-2">Pedido Recebido!</h3>
            <p id="confirmation-message" class="text-gray-400 mb-6">Seu resumo est√° pronto. Clique no bot√£o para enviar via WhatsApp e concluir seu pedido!</p>
            <div id="order-summary" class="text-left bg-gray-700 p-4 rounded-lg mb-6 max-h-60 overflow-y-auto modal-body"></div>
            <div id="initial-confirm-buttons" class="flex flex-col sm:flex-row gap-4 justify-center">
                 <button id="send-whatsapp-btn" class="w-full bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition-all flex items-center justify-center gap-2">
                    <i class="fab fa-whatsapp"></i> Enviar Pedido
                </button>
                <button id="close-confirmation-modal-btn" class="w-full bg-gray-600 text-gray-100 font-bold py-3 px-6 rounded-lg hover:bg-gray-500 transition-all">Fechar</button>
            </div>
            <div id="post-send-buttons" class="hidden flex-col gap-4 justify-center">
                 <p class="text-sm text-yellow-400 mb-4">Ap√≥s enviar a mensagem no WhatsApp, confirme abaixo para limpar seu carrinho.</p>
                 <button id="confirm-order-sent-btn" class="w-full bg-teal-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-teal-600 transition-all flex items-center justify-center gap-2">
                    <i class="fas fa-check-square"></i> Pedido Enviado, Limpar Carrinho
                </button>
                <button id="close-confirmation-modal-btn-2" class="w-full bg-gray-600 text-gray-100 font-bold py-3 px-6 rounded-lg hover:bg-gray-500 transition-all">Manter Carrinho e Fechar</button>
            </div>
        </div>
    </div>
    
    <!-- Custom Alert Modal -->
    <div id="alert-modal" class="alert-modal fixed inset-0 bg-black bg-opacity-60 z-[60] hidden items-center justify-center p-4 opacity-0">
        <div class="bg-gray-800 text-gray-200 rounded-2xl shadow-2xl w-full max-w-sm text-center p-6 transform scale-95 transition-transform">
            <div id="alert-icon" class="mx-auto mb-4"></div>
            <h3 id="alert-title" class="text-xl font-bold text-gray-100 mb-2">Aten√ß√£o!</h3>
            <p id="alert-message" class="text-gray-400 mb-6">Mensagem de alerta.</p>
            <button id="close-alert-modal-btn" class="w-full bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700 transition-all">OK</button>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div id="admin-modal" class="fixed inset-0 bg-black bg-opacity-80 z-[70] hidden items-center justify-center p-4">
        <div class="bg-gray-800 text-gray-200 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-2xl font-bold text-amber-400"><i class="fas fa-user-shield mr-2"></i>Painel do Administrador</h3>
                <button id="close-admin-modal-btn" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <div id="admin-body" class="p-6 space-y-6 overflow-y-auto modal-body">
                <!-- Admin content will be dynamically injected here -->
            </div>
            <div class="p-4 bg-gray-900 border-t border-gray-700 flex flex-wrap justify-between items-center gap-4">
                <div class="flex gap-4">
                    <button id="save-admin-changes-btn" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition-all flex items-center gap-2">
                        <i class="fas fa-save"></i> Salvar Altera√ß√µes
                    </button>
                    <button id="reset-to-defaults-btn" class="bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-700 transition-all flex items-center gap-2 text-sm">
                        <i class="fas fa-undo"></i> Restaurar Padr√£o
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Prompt Modal -->
    <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-70 z-[80] hidden items-center justify-center p-4">
        <div class="bg-gray-800 text-gray-200 rounded-2xl shadow-2xl w-full max-w-sm text-center p-6">
            <h3 class="text-xl font-bold text-amber-400 mb-4">Acesso Restrito</h3>
            <p class="text-gray-400 mb-4">Por favor, insira a senha de administrador.</p>
            <input type="password" id="admin-password-input" class="block w-full bg-gray-700 border-2 border-gray-600 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 p-3 text-base" placeholder="Senha">
            <div class="mt-6 flex gap-4">
                <button id="cancel-password-btn" class="w-full bg-gray-600 text-gray-100 font-bold py-2 px-6 rounded-lg hover:bg-gray-500 transition-all">Cancelar</button>
                <button id="check-password-btn" class="w-full bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700 transition-all">Entrar</button>
            </div>
        </div>
    </div>

    <!-- Generic Confirmation Modal -->
    <div id="confirm-action-modal" class="fixed inset-0 bg-black bg-opacity-70 z-[80] hidden items-center justify-center p-4">
        <div class="bg-gray-800 text-gray-200 rounded-2xl shadow-2xl w-full max-w-sm text-center p-6">
            <div id="confirm-action-icon" class="mx-auto mb-4"><i class="fas fa-exclamation-triangle text-yellow-500 text-5xl"></i></div>
            <h3 id="confirm-action-title" class="text-xl font-bold text-gray-100 mb-2">Confirmar A√ß√£o</h3>
            <p id="confirm-action-message" class="text-gray-400 mb-6">Voc√™ tem certeza?</p>
            <div class="mt-6 flex gap-4">
                <button id="confirm-action-cancel-btn" class="w-full bg-gray-600 text-gray-100 font-bold py-2 px-6 rounded-lg hover:bg-gray-500 transition-all">Cancelar</button>
                <button id="confirm-action-confirm-btn" class="w-full bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition-all">Confirmar</button>
            </div>
        </div>
    </div>
    
    <script type="module">
    // =================================================================================
    // M√ìDULO DE CONFIGURA√á√ÉO (config.js)
    // =================================================================================
    
    // --- IMPORTA√á√ïES DO FIREBASE ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- CONFIGURA√á√ÉO DO FIREBASE ---
    // As suas credenciais foram inseridas aqui.
    const firebaseConfig = {
      apiKey: "AIzaSyA6dAMBp1HCAvcZ3ByyZ1thmQATUfmR7E8",
      authDomain: "cardapiosaborgeral.firebaseapp.com",
      projectId: "cardapiosaborgeral",
      storageBucket: "cardapiosaborgeral.appspot.com", // CORRIGIDO
      messagingSenderId: "615238006330",
      appId: "1:615238006330:web:38aaf9158c0a0eed432703",
      measurementId: "G-2HDSMX7GYB"
    };

    // --- DADOS PADR√ÉO DA APLICA√á√ÉO ---
    const defaultAdminSettings = {
        storeStatus: 'auto', deliveryMode: 'both', openingTime: '14:30', closingTime: '22:15',
        openDays: [1, 2, 3, 4, 5, 6], // Seg-S√°b
        whatsappNumber: '5594991623576', address: 'Av. Rio Branco, Bairro Novo Horizonte, prox a pra√ßa'
    };
    const defaultProducts = [
        { id: 1, name: 'Copo 300ml', price: 14.00, disabled: false }, { id: 2, name: 'Copo 400ml', price: 17.00, disabled: false },
        { id: 3, name: 'Copo 500ml', price: 20.00, disabled: false }, { id: 4, name: 'Barca M', price: 55.00, disabled: true },
    ];
    const defaultToppings = {
        free: { title: 'üçì Frutas e Cremes (Gr√°tis, escolha at√© 3)', limit: 3, items: [ { name: 'Sorvete', disabled: false }, { name: 'Banana', disabled: false }, { name: 'Morango', disabled: false }, { name: 'Manga', disabled: false }, { name: 'Kiwi', disabled: false }, { name: 'Uva', disabled: false }, { name: 'Abacaxi', disabled: false }, { name: 'Creme de Leite Ninho', disabled: false }, { name: 'Creme de Cupua√ßu', disabled: false }, { name: 'Mousse de Maracuj√°', disabled: false }, { name: 'Creme de Avel√£', disabled: false } ] },
        grains: { title: 'üåæ Gr√£os e Cereais (Gr√°tis, escolha at√© 2)', limit: 2, items: [ { name: 'Granola Tradicional', disabled: false }, { name: 'Aveia', disabled: false }, { name: 'Flocos', disabled: false }, { name: 'Tapioca', disabled: false }, { name: 'Pa√ßoca', disabled: false }, { name: 'Leite em P√≥', disabled: false }, { name: 'Amendoim', disabled: false }, { name: 'Coco Ralado', disabled: false } ] },
        caldas: { title: 'üçØ Caldas (Gr√°tis, escolha 1)', limit: 1, items: [ { name: 'Leite Condensado', disabled: false }, { name: 'Calda de Chocolate', disabled: false }, { name: 'Calda de Morango', disabled: false }, { name: 'Calda de Caramelo', disabled: false }, { name: 'Calda de A√ßa√≠', disabled: false }, { name: 'Calda de Kiwi', disabled: false } ] },
        paid_tier2: { title: 'üç´ Doces e Chocolates (+ R$ 3,00 cada)', price: 3.00, items: [ { name: 'Gotas de Chocolate', disabled: false }, { name: 'Confetes', disabled: false }, { name: 'Bis Picado', disabled: false }, { name: 'Ouro Branco', disabled: false }, { name: 'Sonho de Valsa', disabled: false } ] },
        paid_tier3: { title: '‚≠ê Mais alguma coisa? (+ R$ 4,00 cada)', price: 4.00, items: [ { name: 'Sorvete', disabled: false }, { name: 'Banana', disabled: false }, { name: 'Morango', disabled: false }, { name: 'Manga', disabled: false }, { name: 'Kiwi', disabled: false }, { name: 'Uva', disabled: false }, { name: 'Abacaxi', disabled: false }, { name: 'Creme de Leite Ninho', disabled: false }, { name: 'Creme de Cupua√ßu', disabled: false }, { name: 'Mousse de Maracuj√°', disabled: false }, { name: 'Creme de Avel√£', disabled: false } ] }
    };

    // --- CONSTANTES ---
    const CART_STORAGE_KEY = 'saborAcaiteriaCart';
    const CUSTOMER_INFO_STORAGE_KEY = 'saborAcaiteriaCustomerInfo';

    // =================================================================================
    // M√ìDULO DE SERVI√áOS DO FIREBASE (firebaseService.js)
    // =================================================================================
    
    const FirebaseService = {
        db: null,

        // Inicializa o Firebase e a conex√£o com o Firestore
        init() {
            try {
                const app = initializeApp(firebaseConfig);
                this.db = getFirestore(app);
                console.log("Firebase inicializado com sucesso!");
                return true;
            } catch (e) {
                console.error("Erro ao inicializar o Firebase. Verifique a sua firebaseConfig.", e);
                UI.showAlert("Erro de Configura√ß√£o", "N√£o foi poss√≠vel conectar √† base de dados. Verifique a consola para mais detalhes.", true);
                return false;
            }
        },

        // Carrega todos os dados de configura√ß√£o do Firestore
        async loadAllData() {
            if (!this.db) return { adminSettings: defaultAdminSettings, products: defaultProducts, toppings: defaultToppings };

            const getOrCreateDoc = async (docRef, defaultData) => {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    return docSnap.data().data;
                } else {
                    console.log(`Documento n√£o encontrado, criando com padr√£o: ${docRef.id}`);
                    await setDoc(docRef, { data: defaultData });
                    return defaultData;
                }
            };

            try {
                const settingsRef = doc(this.db, "configuracoes", "adminSettings");
                const productsRef = doc(this.db, "configuracoes", "products");
                const toppingsRef = doc(this.db, "configuracoes", "toppings");

                const [adminSettings, products, toppings] = await Promise.all([
                    getOrCreateDoc(settingsRef, defaultAdminSettings),
                    getOrCreateDoc(productsRef, defaultProducts),
                    getOrCreateDoc(toppingsRef, defaultToppings)
                ]);
                console.log("Dados carregados do Firestore com sucesso.");
                return { adminSettings, products, toppings };
            } catch (error) {
                console.error("Erro ao carregar dados do Firestore:", error);
                UI.showAlert("Erro de Base de Dados", "N√£o foi poss√≠vel carregar as configura√ß√µes do card√°pio. Usando valores padr√£o.", true);
                return { adminSettings: defaultAdminSettings, products: defaultProducts, toppings: defaultToppings };
            }
        },

        // Guarda todas as configura√ß√µes do painel de administra√ß√£o
        async saveAllData({ adminSettings, products, toppings }) {
            if (!this.db) {
                UI.showAlert("Erro de Base de Dados", "N√£o foi poss√≠vel salvar. Verifique a conex√£o com o Firebase.", true);
                return false;
            }
            try {
                const settingsRef = doc(this.db, "configuracoes", "adminSettings");
                const productsRef = doc(this.db, "configuracoes", "products");
                const toppingsRef = doc(this.db, "configuracoes", "toppings");

                await Promise.all([
                    setDoc(settingsRef, { data: adminSettings }),
                    setDoc(productsRef, { data: products }),
                    setDoc(toppingsRef, { data: toppings })
                ]);
                return true;
            } catch (error) {
                console.error("Erro ao salvar no Firestore:", error);
                UI.showAlert("Erro ao Salvar", "N√£o foi poss√≠vel salvar as altera√ß√µes na base de dados.", true);
                return false;
            }
        }
    };

    // =================================================================================
    // M√ìDULO DE UI (ui.js)
    // =================================================================================

    const UI = {
        elements: {}, // CORRIGIDO: Inicia vazio

        // CORRIGIDO: M√©todo para popular os elementos depois do DOM carregar
        init() {
            this.elements = {
                productList: document.getElementById('product-list'),
                itemModal: document.getElementById('item-modal'),
                cartModal: document.getElementById('cart-modal'),
                confirmationModal: document.getElementById('confirmation-modal'),
                adminModal: document.getElementById('admin-modal'),
                alertModal: document.getElementById('alert-modal'),
                passwordModal: document.getElementById('password-modal'),
                confirmActionModal: document.getElementById('confirm-action-modal'),
                cartButton: document.getElementById('cart-button'),
                customerNameInput: document.getElementById('customer-name'),
                customerAddressInput: document.getElementById('customer-address'),
                neighborhoodSelect: document.getElementById('neighborhood'),
                deliveryFields: document.getElementById('delivery-fields'),
                deliveryOptionDelivery: document.getElementById('delivery-option-delivery'),
                deliveryOptionTakeout: document.getElementById('delivery-option-takeout'),
                deliveryOptionRadios: document.querySelectorAll('input[name="delivery_option"]'),
                adminPasswordInput: document.getElementById('admin-password-input'),
                storeHoursDisplay: document.getElementById('store-hours-display'),
                storeStatusIndicator: document.getElementById('store-status-indicator'),
                storeStatusBanner: document.getElementById('store-status-banner'),
                storeAddressDisplay: document.getElementById('store-address-display'),
                whatsappLink: document.getElementById('whatsapp-link'),
                cartCount: document.getElementById('cart-count'),
                cartItemsContainer: document.getElementById('cart-items-container'),
                checkoutForm: document.getElementById('checkout-form'),
                cartSummaryDetails: document.getElementById('cart-summary-details'),
                cartSubtotal: document.getElementById('cart-subtotal'),
                cartDeliveryFee: document.getElementById('cart-delivery-fee'),
                cartTotal: document.getElementById('cart-total'),
                modalTitle: document.getElementById('modal-title'),
                modalBody: document.getElementById('modal-body'),
                modalItemTotal: document.getElementById('modal-item-total'),
                orderSummary: document.getElementById('order-summary'),
                initialConfirmButtons: document.getElementById('initial-confirm-buttons'),
                postSendButtons: document.getElementById('post-send-buttons'),
                confirmationIcon: document.getElementById('confirmation-icon'),
                confirmationTitle: document.getElementById('confirmation-title'),
                confirmationMessage: document.getElementById('confirmation-message'),
                adminBody: document.getElementById('admin-body'),
                closeAlertModalBtn: document.getElementById('close-alert-modal-btn'),
                adminPanelBtn: document.getElementById('admin-panel-btn'),
                cancelPasswordBtn: document.getElementById('cancel-password-btn'),
                checkPasswordBtn: document.getElementById('check-password-btn'),
                closeAdminModalBtn: document.getElementById('close-admin-modal-btn'),
                saveAdminChangesBtn: document.getElementById('save-admin-changes-btn'),
                resetToDefaultsBtn: document.getElementById('reset-to-defaults-btn'),
                toggleCartBtn: document.getElementById('toggle-cart-btn'),
                closeCartModalBtn: document.getElementById('close-cart-modal-btn'),
                closeItemModalBtn: document.getElementById('close-item-modal-btn'),
                addToCartBtn: document.getElementById('add-to-cart-btn'),
                finalizeOrderBtn: document.getElementById('finalize-order-btn'),
                closeConfirmationModalBtn: document.getElementById('close-confirmation-modal-btn'),
                closeConfirmationModalBtn2: document.getElementById('close-confirmation-modal-btn-2'),
                sendWhatsappBtn: document.getElementById('send-whatsapp-btn'),
                confirmOrderSentBtn: document.getElementById('confirm-order-sent-btn'),
            };
        },

        // Formata um n√∫mero para a moeda Real (BRL)
        formatCurrency(value) {
            return `R$ ${Number(value).toFixed(2).replace('.', ',')}`;
        },
        
        // Exibe um alerta personalizado
        showAlert(message, title = 'Aten√ß√£o!', isError = false) {
            this.elements.alertModal.querySelector('#alert-message').textContent = message;
            this.elements.alertModal.querySelector('#alert-title').textContent = title;
            const iconContainer = this.elements.alertModal.querySelector('#alert-icon');
            iconContainer.innerHTML = isError 
                ? '<i class="fas fa-exclamation-triangle text-red-500 text-5xl"></i>'
                : '<i class="fas fa-check-circle text-green-500 text-5xl"></i>';
            this.elements.alertModal.classList.remove('hidden');
            setTimeout(() => {
                this.elements.alertModal.classList.remove('opacity-0');
                this.elements.alertModal.querySelector('div > div').classList.remove('scale-95');
            }, 10);
        },

        // Fecha o alerta personalizado
        closeAlertModal() {
            this.elements.alertModal.classList.add('opacity-0');
            this.elements.alertModal.querySelector('div > div').classList.add('scale-95');
            setTimeout(() => { this.elements.alertModal.classList.add('hidden'); }, 300);
        },

        // Abre ou fecha um modal gen√©rico
        toggleModal(modalElement, show) {
            if (show) {
                modalElement.classList.remove('hidden');
                modalElement.classList.add('flex');
            } else {
                modalElement.classList.add('hidden');
                modalElement.classList.remove('flex');
            }
        },
        
        showConfirmationModal(message, onConfirm) {
            this.elements.confirmActionModal.querySelector('#confirm-action-message').textContent = message;
            
            const confirmBtn = this.elements.confirmActionModal.querySelector('#confirm-action-confirm-btn');
            const cancelBtn = this.elements.confirmActionModal.querySelector('#confirm-action-cancel-btn');

            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            newConfirmBtn.addEventListener('click', () => {
                onConfirm();
                this.toggleModal(this.elements.confirmActionModal, false);
            }, { once: true });

            cancelBtn.addEventListener('click', () => this.toggleModal(this.elements.confirmActionModal, false), { once: true });

            this.toggleModal(this.elements.confirmActionModal, true);
        },

        // Atualiza o status da loja (aberto/fechado) na UI
        updateStoreStatus(isStoreOpen, adminSettings) {
            const { storeStatusIndicator, storeStatusBanner, storeHoursDisplay } = this.elements;
            const dayNames = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "S√°b"];
            let daysString = "Fechado";
            if (adminSettings.openDays?.length > 0) {
                daysString = adminSettings.openDays.length === 7 ? "Todos os dias" : adminSettings.openDays.sort().map(i => dayNames[i]).join(', ');
            }
            storeHoursDisplay.querySelector('span').textContent = `${adminSettings.openingTime} √†s ${adminSettings.closingTime} (${daysString})`;

            if (isStoreOpen) {
                storeStatusIndicator.textContent = 'Aberto';
                storeStatusIndicator.className = 'ml-2 px-3 py-1 text-sm rounded-full bg-green-500 text-white font-bold';
                storeStatusBanner.classList.add('hidden');
            } else {
                storeStatusIndicator.textContent = 'Fechado';
                storeStatusIndicator.className = 'ml-2 px-3 py-1 text-sm rounded-full bg-red-500 text-white font-bold';
                storeStatusBanner.innerHTML = `<div class="bg-red-900/50 border-l-4 border-red-500 text-red-300 p-4 rounded-md mb-8 text-center" role="alert"><p class="font-bold text-lg">No momento estamos fechados!</p><p class="text-sm">Voc√™ pode navegar pelo card√°pio, mas os pedidos est√£o suspensos.</p></div>`;
                storeStatusBanner.classList.remove('hidden');
            }
        },

        // Renderiza a lista de produtos na p√°gina principal
        renderProducts(products, isStoreOpen) {
            this.elements.productList.innerHTML = '';
            products.forEach(product => {
                if (product.disabled) return;
                const productCard = document.createElement('div');
                productCard.className = "bg-gray-800 border border-gray-700 rounded-xl p-4 text-center transition-all hover:shadow-lg hover:border-purple-400 cursor-pointer flex flex-col justify-between";
                productCard.dataset.productId = product.id;
                productCard.innerHTML = `
                    <div>
                        <h3 class="font-bold text-xl text-gray-100">${product.name}</h3>
                        <p class="text-2xl font-semibold text-purple-400 mt-2">${this.formatCurrency(product.price)}</p>
                    </div>
                    <button class="mt-4 bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-500 transition-all w-full" ${!isStoreOpen ? 'disabled' : ''}>${isStoreOpen ? 'Montar' : 'Fechado'}</button>
                `;
                this.elements.productList.appendChild(productCard);
            });
        },

        // Renderiza o conte√∫do do carrinho de compras
        renderCart(cart, deliveryFee) {
            const { cartItemsContainer, checkoutForm, cartSummaryDetails, cartSubtotal, cartDeliveryFee, cartTotal, cartCount } = this.elements;
            
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCount.textContent = totalItems;
            this.toggleModal(this.elements.cartButton, totalItems > 0);

            if (totalItems === 0) {
                cartItemsContainer.innerHTML = '<p class="text-gray-500 text-center">Seu carrinho est√° vazio.</p>';
                checkoutForm.classList.add('hidden');
                cartSummaryDetails.classList.add('hidden');
            } else {
                checkoutForm.classList.remove('hidden');
                cartSummaryDetails.classList.remove('hidden');
                cartItemsContainer.innerHTML = cart.map((item, index) => `
                    <div class="flex items-start justify-between p-4 border-b border-gray-700">
                        <div>
                            <p class="font-bold text-lg text-gray-100">${item.name} (x${item.quantity})</p>
                            <div class="text-sm text-gray-400 pl-2 mt-1">
                                ${item.toppings.length > 0 ? item.toppings.map(t => `<span>- ${t.name} ${t.price > 0 ? `(+ ${this.formatCurrency(t.price)})` : ''}</span>`).join('<br>') : '<span>- A√ßa√≠ puro</span>'}
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-lg text-purple-400">${this.formatCurrency(item.price * item.quantity)}</p>
                            <div class="flex items-center gap-2 mt-2">
                                <button data-action="decrease-quantity" data-index="${index}" class="bg-gray-700 w-7 h-7 rounded-full font-bold text-lg flex items-center justify-center">-</button>
                                <span class="font-bold w-5 text-center">${item.quantity}</span>
                                <button data-action="increase-quantity" data-index="${index}" class="bg-gray-700 w-7 h-7 rounded-full font-bold text-lg flex items-center justify-center">+</button>
                                <button data-action="remove-from-cart" data-index="${index}" class="text-red-500 hover:text-red-700 ml-2"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const finalTotal = subtotal + deliveryFee;

            cartSubtotal.textContent = this.formatCurrency(subtotal);
            cartDeliveryFee.textContent = this.formatCurrency(deliveryFee);
            cartTotal.textContent = this.formatCurrency(finalTotal);
        },

        // Renderiza o modal de customiza√ß√£o de item
        renderItemModal(product, toppings) {
            this.elements.modalTitle.textContent = `Monte seu ${product.name}`;
            this.elements.modalBody.innerHTML = `<div class="bg-yellow-900/50 border-l-4 border-yellow-500 text-yellow-300 p-4 rounded-md" role="alert"><div class="flex"><div class="py-1"><i class="fas fa-info-circle mr-3"></i></div><div><p class="font-bold">Aten√ß√£o!</p><p class="text-sm">Escolha seus adicionais com carinho. Nossos copos t√™m espa√ßo limitado.</p></div></div></div>`;

            Object.entries(toppings).forEach(([key, category]) => {
                const section = document.createElement('div');
                let itemsHTML = category.items.filter(item => !item.disabled).map(item => `
                    <label class="flex items-center space-x-3 p-2 rounded-md hover:bg-gray-700 cursor-pointer">
                        <input type="checkbox" class="h-5 w-5 rounded border-gray-500 bg-gray-600 text-purple-600 focus:ring-purple-500" name="${key}" value="${item.name}" data-price="${category.price || 0}">
                        <span class="text-gray-300">${item.name}</span>
                    </label>
                `).join('');
                
                if (itemsHTML.length > 0) {
                    section.innerHTML = `<h4 class="text-lg font-bold text-gray-200 mb-2 pb-1 border-b border-gray-600">${category.title}</h4><div class="grid grid-cols-2 sm:grid-cols-3 gap-2">${itemsHTML}</div>`;
                    this.elements.modalBody.appendChild(section);
                }
            });
            this.toggleModal(this.elements.itemModal, true);
        },

        // Atualiza o total do item no modal de customiza√ß√£o
        updateModalItemTotal(basePrice, toppings) {
            let totalFromToppings = 0;
            const currentToppingsList = [];

            Object.entries(toppings).forEach(([key, category]) => {
                const checkboxes = this.elements.modalBody.querySelectorAll(`input[name="${key}"]`);
                const checkedCheckboxes = this.elements.modalBody.querySelectorAll(`input[name="${key}"]:checked`);

                if (category.limit) {
                    const limitReached = checkedCheckboxes.length >= category.limit;
                    checkboxes.forEach(cb => { cb.disabled = limitReached && !cb.checked; });
                }
                
                checkedCheckboxes.forEach(checkbox => {
                    const price = parseFloat(checkbox.dataset.price);
                    if (price > 0) totalFromToppings += price;
                    currentToppingsList.push({ name: checkbox.value, price: price });
                });
            });
            
            const newPrice = basePrice + totalFromToppings;
            this.elements.modalItemTotal.textContent = this.formatCurrency(newPrice);
            return { price: newPrice, toppings: currentToppingsList.sort((a, b) => a.price - b.price) };
        },
        
        // Renderiza o painel de administra√ß√£o
        renderAdminPanel(adminSettings, products, toppings) {
            const { adminBody } = this.elements;
            adminBody.innerHTML = '';
            const daysOfWeek = ["Domingo", "Segunda", "Ter√ßa", "Quarta", "Quinta", "Sexta", "S√°bado"];
            
            // Renderiza as configura√ß√µes gerais e de funcionamento
            adminBody.innerHTML += `
                <div class="p-4 bg-gray-900/50 rounded-lg">
                    <h4 class="text-xl font-bold text-purple-400 mb-4">Configura√ß√µes Gerais</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                        <div><label for="admin-whatsapp-number" class="block text-sm font-medium text-gray-300 mb-1">N√∫mero do WhatsApp</label><input type="text" id="admin-whatsapp-number" value="${adminSettings.whatsappNumber}" class="bg-gray-700 p-2 rounded-md border border-gray-600 w-full"></div>
                        <div><label for="admin-address" class="block text-sm font-medium text-gray-300 mb-1">Endere√ßo da Loja</label><input type="text" id="admin-address" value="${adminSettings.address}" class="bg-gray-700 p-2 rounded-md border border-gray-600 w-full"></div>
                    </div>
                </div>
                <div class="p-4 bg-gray-900/50 rounded-lg">
                    <h4 class="text-xl font-bold text-purple-400 mb-4">Controle de Funcionamento</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                        <div>
                            <h5 class="font-semibold text-gray-300 mb-2">Status da Loja</h5>
                            <div class="space-y-2">
                                <label class="flex items-center p-2 rounded-md hover:bg-gray-700 cursor-pointer"><input type="radio" name="admin_store_status" value="auto" class="h-4 w-4 mr-2 text-purple-600" ${adminSettings.storeStatus === 'auto' ? 'checked' : ''}> Autom√°tico</label>
                                <label class="flex items-center p-2 rounded-md hover:bg-gray-700 cursor-pointer"><input type="radio" name="admin_store_status" value="open" class="h-4 w-4 mr-2 text-purple-600" ${adminSettings.storeStatus === 'open' ? 'checked' : ''}> Aberto (Manual)</label>
                                <label class="flex items-center p-2 rounded-md hover:bg-gray-700 cursor-pointer"><input type="radio" name="admin_store_status" value="closed" class="h-4 w-4 mr-2 text-purple-600" ${adminSettings.storeStatus === 'closed' ? 'checked' : ''}> Fechado (Manual)</label>
                            </div>
                        </div>
                        <div>
                             <h5 class="font-semibold text-gray-300 mb-2">Op√ß√µes de Pedido</h5>
                             <div class="space-y-2">
                                <label class="flex items-center p-2 rounded-md hover:bg-gray-700 cursor-pointer"><input type="radio" name="admin_delivery_mode" value="both" class="h-4 w-4 mr-2 text-purple-600" ${adminSettings.deliveryMode === 'both' ? 'checked' : ''}> Delivery e Retirada</label>
                                <label class="flex items-center p-2 rounded-md hover:bg-gray-700 cursor-pointer"><input type="radio" name="admin_delivery_mode" value="delivery" class="h-4 w-4 mr-2 text-purple-600" ${adminSettings.deliveryMode === 'delivery' ? 'checked' : ''}> Apenas Delivery</label>
                                <label class="flex items-center p-2 rounded-md hover:bg-gray-700 cursor-pointer"><input type="radio" name="admin_delivery_mode" value="takeout" class="h-4 w-4 mr-2 text-purple-600" ${adminSettings.deliveryMode === 'takeout' ? 'checked' : ''}> Apenas Retirada</label>
                            </div>
                        </div>
                        <div class="md:col-span-2">
                            <h5 class="font-semibold text-gray-300 mb-2">Hor√°rio (Modo Autom√°tico)</h5>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                <div class="sm:col-span-2">
                                    <h6 class="text-sm font-medium text-gray-400 mb-1">Dias da Semana</h6>
                                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-x-4 gap-y-2 text-sm">${daysOfWeek.map((day, index) => `<label class="flex items-center gap-2 p-1.5 rounded-md hover:bg-gray-700 cursor-pointer"><input type="checkbox" name="admin_open_day" value="${index}" class="h-4 w-4 rounded text-purple-600" ${adminSettings.openDays.includes(index) ? 'checked' : ''}><span>${day}</span></label>`).join('')}</div>
                                </div>
                                <div>
                                    <h6 class="text-sm font-medium text-gray-400 mb-1">Hor√°rio</h6>
                                    <div class="flex items-center gap-2">
                                        <input type="time" id="admin-opening-time" value="${adminSettings.openingTime}" class="bg-gray-700 p-2 rounded-md border border-gray-600 w-full">
                                        <span>√†s</span>
                                        <input type="time" id="admin-closing-time" value="${adminSettings.closingTime}" class="bg-gray-700 p-2 rounded-md border border-gray-600 w-full">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;

            // Renderiza os produtos
            let productsHTML = `<div class="p-4 bg-gray-900/50 rounded-lg"><h4 class="text-xl font-bold text-purple-400 mb-4">Card√°pio: Tamanhos (Produtos)</h4><div id="admin-products-list" class="space-y-3">`;
            products.forEach((product) => { productsHTML += this.getAdminItemHTML('product', product); });
            productsHTML += `</div><button data-action="add-admin-item" data-type="product" class="mt-4 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-500 text-sm"><i class="fas fa-plus mr-2"></i>Adicionar Tamanho</button></div>`;
            adminBody.innerHTML += productsHTML;
            
            // Renderiza os complementos
            let toppingsHTML = `<div class="p-4 bg-gray-900/50 rounded-lg mt-6"><h4 class="text-xl font-bold text-purple-400 mb-4">Card√°pio: Complementos</h4>`;
            Object.entries(toppings).forEach(([key, category]) => {
                toppingsHTML += `<div class="mt-4"><h5 class="font-semibold text-gray-300 mb-2">${category.title}</h5><div id="admin-toppings-${key}" class="space-y-2">`;
                (category.items || []).forEach((item) => { toppingsHTML += this.getAdminItemHTML('topping', item, key); });
                toppingsHTML += `</div><button data-action="add-admin-item" data-type="topping" data-category="${key}" class="mt-3 bg-blue-600 text-white font-semibold py-1 px-3 rounded-lg hover:bg-blue-500 text-xs"><i class="fas fa-plus mr-1"></i>Adicionar</button></div>`;
            });
            toppingsHTML += `</div>`;
            adminBody.innerHTML += toppingsHTML;
        },

        // Gera o HTML para um item no painel de admin
        getAdminItemHTML(type, item, categoryKey = '') {
            if (type === 'product') {
                return `<div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-center p-2 bg-gray-700 rounded-md admin-item" data-type="product">
                    <input type="text" value="${item.name}" class="admin-name col-span-2 bg-gray-600 p-2 rounded-md border-gray-500" placeholder="Nome do Produto">
                    <input type="number" value="${item.price.toFixed(2)}" class="admin-price bg-gray-600 p-2 rounded-md border-gray-500" placeholder="Pre√ßo">
                    <div class="flex items-center justify-between gap-2">
                        <label class="flex items-center gap-2 text-sm cursor-pointer"><input type="checkbox" class="admin-disabled h-5 w-5" ${item.disabled ? 'checked' : ''}> Bloquear</label>
                        <button data-action="remove-admin-item" class="text-red-500 hover:text-red-400"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>`;
            } else { // Topping
                return `<div class="flex items-center gap-3 p-2 bg-gray-700 rounded-md admin-item" data-type="topping" data-category="${categoryKey}">
                    <input type="text" value="${item.name}" class="admin-name flex-grow bg-gray-600 p-2 rounded-md border-gray-500" placeholder="Nome do Complemento">
                    <label class="flex items-center gap-2 text-sm cursor-pointer whitespace-nowrap"><input type="checkbox" class="admin-disabled h-5 w-5" ${item.disabled ? 'checked' : ''}> Bloquear</label>
                    <button data-action="remove-admin-item" class="text-red-500 hover:text-red-400"><i class="fas fa-trash-alt"></i></button>
                </div>`;
            }
        },
    };


    // =================================================================================
    // M√ìDULO PRINCIPAL DA APLICA√á√ÉO (app.js)
    // =================================================================================

    const App = {
        // Estado da aplica√ß√£o
        state: {
            cart: [],
            currentItem: null,
            whatsAppMessage: '',
            isStoreOpen: false,
            adminSettings: {},
            products: [],
            toppings: {},
        },

        // Ponto de entrada da aplica√ß√£o
        async init() {
            // CORRIGIDO: Inicializa a UI primeiro para garantir que os elementos existem
            UI.init();
            
            // 1. Inicializar Firebase
            if (!FirebaseService.init()) return; // Aborta se o Firebase falhar

            // 2. Carregar todos os dados (Firestore e LocalStorage)
            const firestoreData = await FirebaseService.loadAllData();
            this.state.adminSettings = firestoreData.adminSettings;
            this.state.products = firestoreData.products;
            this.state.toppings = firestoreData.toppings;
            this.loadCartFromStorage();
            this.loadCustomerInfoFromStorage();

            // 3. Configurar e adicionar os event listeners
            this.initEventListeners();

            // 4. Renderizar a UI inicial
            this.updateFullUI();
        },

        // Atualiza toda a UI com base no estado atual
        updateFullUI() {
            this.checkStoreStatus();
            UI.updateStoreStatus(this.state.isStoreOpen, this.state.adminSettings);
            UI.elements.storeAddressDisplay.textContent = this.state.adminSettings.address;
            UI.elements.whatsappLink.href = `https://wa.me/${this.state.adminSettings.whatsappNumber}`;
            UI.renderProducts(this.state.products, this.state.isStoreOpen);
            this.renderCart();
            this.renderDeliveryOptions();
        },

        // Adiciona todos os event listeners da aplica√ß√£o
        initEventListeners() {
            // Event delegation para cliques em elementos din√¢micos
            document.body.addEventListener('click', (e) => {
                const target = e.target;
                const productCard = target.closest('[data-product-id]');
                const actionButton = target.closest('[data-action]');

                if (productCard) {
                    this.handleOpenItemModal(productCard.dataset.productId);
                } else if (actionButton) {
                    const { action, index, type, category } = actionButton.dataset;
                    e.preventDefault(); // Previne comportamento padr√£o
                    switch (action) {
                        case 'decrease-quantity': this.updateQuantity(index, -1); break;
                        case 'increase-quantity': this.updateQuantity(index, 1); break;
                        case 'remove-from-cart': this.removeFromCart(index); break;
                        case 'add-admin-item': this.addAdminItem(type, category); break;
                        case 'remove-admin-item': actionButton.closest('.admin-item').remove(); break;
                    }
                }
            });

            // Listeners para modais e bot√µes est√°ticos
            UI.elements.closeAlertModalBtn.addEventListener('click', () => UI.closeAlertModal());
            UI.elements.adminPanelBtn.addEventListener('click', () => UI.toggleModal(UI.elements.passwordModal, true));
            UI.elements.cancelPasswordBtn.addEventListener('click', () => UI.toggleModal(UI.elements.passwordModal, false));
            UI.elements.checkPasswordBtn.addEventListener('click', () => this.checkAdminPassword());
            UI.elements.adminPasswordInput.addEventListener('keypress', (e) => e.key === 'Enter' && this.checkAdminPassword());
            UI.elements.closeAdminModalBtn.addEventListener('click', () => UI.toggleModal(UI.elements.adminModal, false));
            UI.elements.saveAdminChangesBtn.addEventListener('click', () => this.saveAdminChanges());
            UI.elements.resetToDefaultsBtn.addEventListener('click', () => this.resetToDefaults());
            UI.elements.toggleCartBtn.addEventListener('click', () => this.toggleCartModal());
            UI.elements.closeCartModalBtn.addEventListener('click', () => this.toggleCartModal());
            UI.elements.closeItemModalBtn.addEventListener('click', () => UI.toggleModal(UI.elements.itemModal, false));
            UI.elements.addToCartBtn.addEventListener('click', () => this.addToCart());
            UI.elements.finalizeOrderBtn.addEventListener('click', () => this.finalizeOrder());
            
            // Listeners para o modal de confirma√ß√£o
            const closeConfirmation = () => UI.toggleModal(UI.elements.confirmationModal, false);
            UI.elements.closeConfirmationModalBtn.addEventListener('click', closeConfirmation);
            UI.elements.closeConfirmationModalBtn2.addEventListener('click', closeConfirmation);
            UI.elements.sendWhatsappBtn.addEventListener('click', () => this.sendOrderViaWhatsApp());
            UI.elements.confirmOrderSentBtn.addEventListener('click', () => this.confirmOrderSent());

            // Listeners para inputs do formul√°rio
            UI.elements.customerNameInput.addEventListener('input', () => this.saveCustomerInfoToStorage());
            UI.elements.customerAddressInput.addEventListener('input', () => this.saveCustomerInfoToStorage());
            UI.elements.neighborhoodSelect.addEventListener('change', () => {
                this.saveCustomerInfoToStorage();
                this.renderCart();
            });
            UI.elements.deliveryOptionRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    this.toggleDeliveryFields();
                    this.saveCustomerInfoToStorage();
                });
            });
            
            // Listener para checkboxes no modal de item
            UI.elements.modalBody.addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    this.updateModalItemTotal();
                }
            });
        },
        
        // --- L√ìGICA DE ESTADO E DADOS ---
        
        loadCartFromStorage() { this.state.cart = JSON.parse(localStorage.getItem(CART_STORAGE_KEY)) || []; },
        saveCartToStorage() { localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(this.state.cart)); },

        loadCustomerInfoFromStorage() {
            const info = JSON.parse(localStorage.getItem(CUSTOMER_INFO_STORAGE_KEY)) || {};
            UI.elements.customerNameInput.value = info.name || '';
            UI.elements.customerAddressInput.value = info.address || '';
            UI.elements.neighborhoodSelect.value = info.neighborhood || '';
            if (info.deliveryOption) {
                const radio = document.querySelector(`input[name="delivery_option"][value="${info.deliveryOption}"]`);
                if (radio) radio.checked = true;
            }
        },
        saveCustomerInfoToStorage() {
            const info = {
                name: UI.elements.customerNameInput.value,
                address: UI.elements.customerAddressInput.value,
                neighborhood: UI.elements.neighborhoodSelect.value,
                deliveryOption: document.querySelector('input[name="delivery_option"]:checked')?.value
            };
            localStorage.setItem(CUSTOMER_INFO_STORAGE_KEY, JSON.stringify(info));
        },
        
        // --- L√ìGICA DO CARRINHO ---

        addToCart() {
            const { currentItem, cart } = this.state;
            if (!currentItem) return;

            const existingItemIndex = cart.findIndex(item => {
                if (item.id !== currentItem.id || item.toppings.length !== currentItem.toppings.length) return false;
                const currentToppingsSet = new Set(currentItem.toppings.map(t => t.name));
                const existingToppingsSet = new Set(item.toppings.map(t => t.name));
                return currentToppingsSet.size === existingToppingsSet.size && [...currentToppingsSet].every(t => existingToppingsSet.has(t));
            });

            if (existingItemIndex > -1) {
                cart[existingItemIndex].quantity++;
            } else {
                cart.push({ ...currentItem });
            }
            
            this.saveCartToStorage();
            UI.toggleModal(UI.elements.itemModal, false);
            this.renderCart();
        },

        updateQuantity(index, change) {
            if (this.state.cart[index].quantity + change > 0) {
                this.state.cart[index].quantity += change;
            } else {
                this.state.cart.splice(index, 1);
            }
            this.saveCartToStorage();
            this.renderCart();
        },

        removeFromCart(index) {
            this.state.cart.splice(index, 1);
            this.saveCartToStorage();
            this.renderCart();
        },

        renderCart() {
            const deliveryOption = document.querySelector('input[name="delivery_option"]:checked')?.value;
            let deliveryFee = 0;
            if (deliveryOption === 'delivery' && this.state.cart.length > 0) {
                const selectedOption = UI.elements.neighborhoodSelect.options[UI.elements.neighborhoodSelect.selectedIndex];
                deliveryFee = parseFloat(selectedOption.dataset.fee || 0);
            }
            UI.renderCart(this.state.cart, deliveryFee);
        },

        toggleCartModal() {
            const isHidden = UI.elements.cartModal.classList.contains('hidden');
            if (isHidden) {
                this.renderDeliveryOptions();
                this.renderCart();
            }
            UI.toggleModal(UI.elements.cartModal, isHidden);
        },

        // --- L√ìGICA DE FUNCIONAMENTO DA LOJA ---
        checkStoreStatus() {
            const { storeStatus, openDays, openingTime, closingTime } = this.state.adminSettings;
            if (storeStatus === 'open') { this.state.isStoreOpen = true; return; }
            if (storeStatus === 'closed') { this.state.isStoreOpen = false; return; }
            
            const now = new Date();
            const currentDay = now.getDay();
            const isTodayOpenDay = openDays?.includes(currentDay);

            if (!isTodayOpenDay) { this.state.isStoreOpen = false; return; }

            const openTime = parseInt(openingTime.replace(':', ''));
            const closeTime = parseInt(closingTime.replace(':', ''));
            const currentTime = now.getHours() * 100 + now.getMinutes();
            this.state.isStoreOpen = (currentTime >= openTime && currentTime <= closeTime);
        },

        // --- L√ìGICA DE CUSTOMIZA√á√ÉO DE ITENS ---
        handleOpenItemModal(productId) {
            if (!this.state.isStoreOpen) {
                UI.showAlert('A loja est√° fechada e n√£o √© poss√≠vel montar pedidos agora.', 'Loja Fechada', true);
                return;
            }
            const product = this.state.products.find(p => p.id.toString() === productId);
            if (!product) return;
            
            this.state.currentItem = {
                id: productId, name: product.name, basePrice: product.price, quantity: 1,
                price: product.price, toppings: []
            };
            
            UI.renderItemModal(product, this.state.toppings);
            this.updateModalItemTotal();
        },
        
        updateModalItemTotal() {
            const { price, toppings } = UI.updateModalItemTotal(this.state.currentItem.basePrice, this.state.toppings);
            this.state.currentItem.price = price;
            this.state.currentItem.toppings = toppings;
        },

        // --- L√ìGICA DE FINALIZA√á√ÉO DE PEDIDO ---
        finalizeOrder() {
            if (!this.state.isStoreOpen) { UI.showAlert('A loja est√° fechada.', 'Loja Fechada', true); return; }
            if (this.state.cart.length === 0) { UI.showAlert('Seu carrinho est√° vazio!', 'Carrinho Vazio', true); return; }
            
            const name = UI.elements.customerNameInput.value.trim();
            const address = UI.elements.customerAddressInput.value.trim();
            const neighborhood = UI.elements.neighborhoodSelect.value;
            const deliveryOption = document.querySelector('input[name="delivery_option"]:checked')?.value;

            if (!deliveryOption) { UI.showAlert('Nenhuma op√ß√£o de entrega/retirada dispon√≠vel.', 'Ops!', true); return; }
            if (!name) { UI.showAlert('Por favor, preencha seu Nome.', 'Dados Incompletos', true); return; }
            if (deliveryOption === 'delivery' && (!address || !neighborhood)) { UI.showAlert('Preencha o Bairro e o Endere√ßo para entrega.', 'Dados Incompletos', true); return; }

            const payment = document.getElementById('payment-method').value;
            const obs = document.getElementById('observations').value.trim();
            const selectedOption = UI.elements.neighborhoodSelect.options[UI.elements.neighborhoodSelect.selectedIndex];
            const deliveryFee = deliveryOption === 'delivery' ? parseFloat(selectedOption.dataset.fee || 0) : 0;
            const subtotal = this.state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const finalTotal = subtotal + deliveryFee;

            let summary = `*NOVO PEDIDO - SABOR A√áA√çTERIA*\n\n*Cliente:* ${name}\n`;
            if (deliveryOption === 'delivery') {
                summary += `*Op√ß√£o:* ENTREGA\n*Endere√ßo:* ${address}, ${neighborhood}\n\n`;
            } else {
                summary += `*Op√ß√£o:* RETIRAR NA LOJA\n\n`;
            }
            summary += `*ITENS DO PEDIDO:*\n------------------------\n`;
            this.state.cart.forEach(item => {
                summary += `*${item.quantity}x ${item.name}*\n`;
                if (item.toppings.length > 0) {
                    item.toppings.forEach(t => { summary += `  - ${t.name}\n`; });
                } else {
                    summary += `  - A√ßa√≠ puro\n`;
                }
                summary += `Subtotal: ${UI.formatCurrency(item.price * item.quantity)}\n------------------------\n`;
            });
            summary += `\n*Subtotal dos Itens: ${UI.formatCurrency(subtotal)}*\n`;
            if (deliveryFee > 0) summary += `*Taxa de Entrega: ${UI.formatCurrency(deliveryFee)}*\n`;
            summary += `*TOTAL DO PEDIDO: ${UI.formatCurrency(finalTotal)}*\n*Forma de Pagamento:* ${payment}\n`;
            if (obs) summary += `*Observa√ß√µes:* ${obs}\n`;

            this.state.whatsAppMessage = encodeURIComponent(summary);
            UI.elements.orderSummary.innerHTML = summary.replace(/\n/g, '<br>').replace(/\*(.*?)\*/g, '<strong>$1</strong>');
            this.toggleCartModal();
            UI.toggleModal(UI.elements.confirmationModal, true);
        },

        sendOrderViaWhatsApp() {
            window.open(`https://wa.me/${this.state.adminSettings.whatsappNumber}?text=${this.state.whatsAppMessage}`, '_blank');
            UI.elements.confirmationIcon.innerHTML = '<i class="fab fa-whatsapp-square text-green-400 text-6xl mb-4"></i>';
            UI.elements.confirmationTitle.textContent = 'Quase l√°!';
            UI.elements.confirmationMessage.textContent = 'Ap√≥s enviar sua mensagem no WhatsApp, clique abaixo para confirmar e limpar seu carrinho.';
            UI.elements.initialConfirmButtons.classList.add('hidden');
            UI.elements.postSendButtons.classList.remove('hidden');
            UI.elements.postSendButtons.classList.add('flex');
        },

        confirmOrderSent() {
            this.state.cart = [];
            this.saveCartToStorage();
            UI.toggleModal(UI.elements.confirmationModal, false);
            this.renderCart();
            UI.showAlert('√ìtimo! Seu carrinho foi limpo.', 'Pedido Enviado');
        },
        
        // --- L√ìGICA DO PAINEL DE ADMINISTRA√á√ÉO ---
        checkAdminPassword() {
            if (UI.elements.adminPasswordInput.value === "admin123") {
                UI.toggleModal(UI.elements.passwordModal, false);
                UI.renderAdminPanel(this.state.adminSettings, this.state.products, this.state.toppings);
                UI.toggleModal(UI.elements.adminModal, true);
            } else {
                UI.showAlert("Senha incorreta!", 'Acesso Negado', true);
            }
            UI.elements.adminPasswordInput.value = '';
        },

        async saveAdminChanges() {
            const newAdminSettings = {
                storeStatus: document.querySelector('input[name="admin_store_status"]:checked').value,
                deliveryMode: document.querySelector('input[name="admin_delivery_mode"]:checked').value,
                openingTime: document.getElementById('admin-opening-time').value,
                closingTime: document.getElementById('admin-closing-time').value,
                openDays: Array.from(document.querySelectorAll('input[name="admin_open_day"]:checked')).map(cb => parseInt(cb.value)),
                whatsappNumber: document.getElementById('admin-whatsapp-number').value,
                address: document.getElementById('admin-address').value,
            };
            
            const newProducts = Array.from(document.querySelectorAll('#admin-products-list .admin-item')).map((item, index) => ({
                id: Date.now() + index,
                name: item.querySelector('.admin-name').value,
                price: parseFloat(item.querySelector('.admin-price').value),
                disabled: item.querySelector('.admin-disabled').checked,
            }));

            const newToppings = { ...this.state.toppings };
            Object.keys(newToppings).forEach(key => {
                const items = Array.from(document.querySelectorAll(`#admin-toppings-${key} .admin-item`)).map(item => ({
                    name: item.querySelector('.admin-name').value,
                    disabled: item.querySelector('.admin-disabled').checked,
                }));
                newToppings[key] = { ...newToppings[key], items };
            });

            const success = await FirebaseService.saveAllData({ adminSettings: newAdminSettings, products: newProducts, toppings: newToppings });
            if (success) {
                UI.showAlert('Configura√ß√µes salvas na base de dados!', 'Salvo!', false);
                UI.toggleModal(UI.elements.adminModal, false);
                await this.init(); // Recarrega tudo
            }
        },

        resetToDefaults() {
            UI.showConfirmationModal(
                "Tem certeza que deseja restaurar tudo para os valores padr√£o? As altera√ß√µes ser√£o salvas na base de dados.",
                async () => {
                    const success = await FirebaseService.saveAllData({ adminSettings: defaultAdminSettings, products: defaultProducts, toppings: defaultToppings });
                    if (success) {
                        UI.showAlert('Configura√ß√µes restauradas! A p√°gina ser√° recarregada.', 'Sucesso', false);
                        setTimeout(() => window.location.reload(), 2500);
                    }
                }
            );
        },
        
        addAdminItem(type, categoryKey) {
            const newItemData = type === 'product' ? { name: 'Novo Produto', price: 0.00, disabled: false } : { name: 'Novo Complemento', disabled: false };
            const newItemHTML = UI.getAdminItemHTML(type, newItemData, categoryKey);
            const containerId = type === 'product' ? 'admin-products-list' : `admin-toppings-${categoryKey}`;
            document.getElementById(containerId).insertAdjacentHTML('beforeend', newItemHTML);
        },

        // --- L√ìGICA DE OP√á√ïES DE ENTREGA ---
        renderDeliveryOptions() {
            const { deliveryMode } = this.state.adminSettings;
            const deliveryLabel = UI.elements.deliveryOptionDelivery;
            const takeoutLabel = UI.elements.deliveryOptionTakeout;
            const deliveryOptionsContainer = document.getElementById('delivery-options');
            
            const showDelivery = deliveryMode === 'both' || deliveryMode === 'delivery';
            const showTakeout = deliveryMode === 'both' || deliveryMode === 'takeout';

            deliveryLabel.classList.toggle('hidden', !showDelivery);
            takeoutLabel.classList.toggle('hidden', !showTakeout);
            deliveryOptionsContainer.classList.toggle('hidden', !showDelivery && !showTakeout);

            const currentSelected = document.querySelector('input[name="delivery_option"]:checked');
            if (!currentSelected || currentSelected.closest('label').classList.contains('hidden')) {
                if (showDelivery) deliveryLabel.querySelector('input').checked = true;
                else if (showTakeout) takeoutLabel.querySelector('input').checked = true;
            }
            this.toggleDeliveryFields();
        },

        toggleDeliveryFields() {
            const deliveryOption = document.querySelector('input[name="delivery_option"]:checked')?.value;
            UI.elements.deliveryFields.classList.toggle('hidden', deliveryOption === 'takeout' || !deliveryOption);
            this.renderCart();
        }
    };

    // Inicia a aplica√ß√£o quando o DOM estiver pronto
    document.addEventListener('DOMContentLoaded', () => App.init());

    </script>
</body>
</html>
