<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedido Online - SABOR AÇAÍTERIA</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-body::-webkit-scrollbar {
            width: 8px;
        }
        .modal-body::-webkit-scrollbar-track {
            background: #1f2937;
            border-radius: 10px;
        }
        .modal-body::-webkit-scrollbar-thumb {
            background: #581c87;
            border-radius: 10px;
        }
        .modal-body::-webkit-scrollbar-thumb:hover {
            background: #6b21a8;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        input[type="checkbox"]:disabled + span {
            color: #6b7280;
            cursor: not-allowed;
        }
        .alert-modal {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        input[type="radio"]:checked + div > .radio-title {
            color: #c084fc;
        }
        /* Custom style for time input icon */
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(0.8);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-300">

    <div class="container mx-auto p-4 sm:p-8 max-w-4xl">

        <!-- Header Section -->
        <header class="text-center mb-8 p-6 rounded-2xl bg-gradient-to-tr from-black to-gray-800 text-white shadow-lg">
            <h1 class="text-5xl md:text-6xl font-black tracking-tight text-amber-400">SABOR AÇAÍTERIA</h1>
            <p class="text-lg md:text-xl mt-2 text-gray-300 opacity-90">Monte seu pedido online de forma fácil e rápida!</p>
            <p id="store-hours-display" class="text-md md:text-lg mt-3 text-gray-300 opacity-90 bg-white/10 rounded-full px-4 py-1 inline-flex items-center justify-center">
                <i class="fas fa-clock mr-2"></i> <span>Carregando horário...</span>
                <span id="store-status-indicator" class="ml-2 px-3 py-1 text-sm rounded-full"></span>
            </p>
        </header>

        <!-- Store Status Banner -->
        <div id="store-status-banner" class="hidden"></div>

        <main class="space-y-8">
            <!-- Products Section -->
            <section id="tamanhos" class="bg-gray-800 p-6 rounded-2xl shadow-md">
                <h2 class="text-3xl font-bold text-purple-400 mb-4 border-b-2 border-purple-800 pb-2">Escolha o Tamanho</h2>
                <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Products will be dynamically injected by JavaScript -->
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="text-center mt-10 space-y-4">
            <div class="bg-gray-800 p-4 rounded-2xl shadow-md border-2 border-gray-700">
                 <h3 class="text-lg font-bold text-purple-400 mb-2 flex items-center justify-center gap-2">
                    <i class="fas fa-map-marker-alt"></i>
                    Nosso Endereço
                </h3>
                 <p class="text-gray-300 text-base">
                    Av. Rio Branco, Bairro Novo Horizonte, prox a praça
                </p>
            </div>
            <div class="text-gray-400 pt-2">
                <p>Siga-nos no Instagram: 
                    <a href="https://www.instagram.com/sabor_acaiteria_delivery/profilecard/?igsh=NjF2ZWMwNHNiNzI0" target="_blank" class="font-semibold text-purple-400 hover:underline">@sabor_acaiteria_delivery</a>
                </p>
            </div>
            <!-- Admin Panel Button -->
            <div class="mt-6">
                 <a href="#" onclick="openAdminPanel(event)" class="inline-block bg-amber-400 text-gray-900 font-bold py-3 px-6 rounded-lg hover:bg-amber-500 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                    <i class="fas fa-user-shield mr-2"></i>Painel do Administrador
                </a>
            </div>
        </footer>
    </div>

    <!-- Floating WhatsApp Button -->
    <a href="https://wa.me/5594991623576" target="_blank" class="fixed bottom-5 left-5 z-50">
        <button class="bg-green-500 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center hover:bg-green-600 transition-transform transform hover:scale-110">
            <i class="fab fa-whatsapp text-3xl"></i>
        </button>
    </a>

    <!-- Floating Cart Button -->
    <div id="cart-button" class="fixed bottom-5 right-5 z-50 hidden">
        <button onclick="toggleCartModal()" class="bg-purple-600 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center hover:bg-purple-700 transition-transform transform hover:scale-110">
            <i class="fas fa-shopping-cart text-2xl"></i>
            <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center">0</span>
        </button>
    </div>

    <!-- Item Customization Modal -->
    <div id="item-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4">
        <div class="bg-gray-800 text-gray-200 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 id="modal-title" class="text-2xl font-bold text-purple-400">Monte seu Açaí</h3>
                <button onclick="closeItemModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <div id="modal-body" class="p-6 space-y-6 overflow-y-auto modal-body">
                <!-- Toppings will be dynamically injected by JavaScript -->
            </div>
            <div class="p-4 bg-gray-900 border-t border-gray-700 flex justify-between items-center">
                <div>
                    <span class="text-lg font-medium text-gray-300">Total do Item:</span>
                    <span id="modal-item-total" class="text-2xl font-bold text-purple-400 ml-2">R$ 0,00</span>
                </div>
                <button id="add-to-cart-btn" class="bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition-all flex items-center gap-2">
                    <i class="fas fa-cart-plus"></i> Adicionar ao Carrinho
                </button>
            </div>
        </div>
    </div>

    <!-- Cart and Checkout Modal -->
    <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4">
         <div class="bg-gray-800 text-gray-200 rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-2xl font-bold text-purple-400">Seu Carrinho e Pedido</h3>
                <button onclick="toggleCartModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <div class="p-6 space-y-6 overflow-y-auto modal-body">
                <div id="cart-items-container"></div>
                <div id="cart-summary-details" class="pt-4 mt-4 border-t border-gray-700 space-y-2 hidden">
                     <div class="flex justify-between text-gray-400">
                         <span>Subtotal</span>
                         <span id="cart-subtotal">R$ 0,00</span>
                     </div>
                     <div class="flex justify-between text-gray-400">
                         <span>Taxa de Entrega</span>
                         <span id="cart-delivery-fee">R$ 0,00</span>
                     </div>
                </div>
                <div id="checkout-form" class="space-y-4 pt-6 border-t border-gray-700 hidden">
                    <h4 class="text-xl font-bold text-gray-200">Informações do Pedido</h4>
                    <div id="delivery-options">
                        <div class="flex flex-col sm:flex-row gap-4">
                            <label id="delivery-option-delivery" class="flex-1 flex items-center p-3 border-2 border-gray-600 rounded-lg cursor-pointer has-[:checked]:border-purple-500 has-[:checked]:bg-purple-900/50">
                                <input type="radio" name="delivery_option" value="delivery" class="hidden" checked>
                                <div class="flex items-center">
                                    <span class="mr-3"><i class="fas fa-motorcycle text-xl text-purple-400"></i></span>
                                    <div><span class="font-semibold text-gray-300 block radio-title">Delivery (Entrega)</span><span class="text-sm text-gray-500">20-60 min</span></div>
                                </div>
                            </label>
                            <label id="delivery-option-takeout" class="flex-1 flex items-center p-3 border-2 border-gray-600 rounded-lg cursor-pointer has-[:checked]:border-purple-500 has-[:checked]:bg-purple-900/50">
                                <input type="radio" name="delivery_option" value="takeout" class="hidden">
                                <div class="flex items-center">
                                    <span class="mr-3"><i class="fas fa-store text-xl text-purple-400"></i></span>
                                    <div><span class="font-semibold text-gray-300 block radio-title">Retirar na Loja</span><span class="text-sm text-gray-500">20-30 min</span></div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div>
                        <label for="customer-name" class="block text-sm font-medium text-gray-400">Seu Nome</label>
                        <input type="text" id="customer-name" class="mt-1 block w-full bg-gray-700 border-2 border-gray-600 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 p-3 text-base" required>
                    </div>
                    <div id="delivery-fields" class="space-y-4">
                         <div>
                            <label for="neighborhood" class="block text-sm font-medium text-gray-400">Selecione o Bairro</label>
                            <select id="neighborhood" class="mt-1 block w-full bg-gray-700 border-2 border-gray-600 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 p-3 text-base">
                                <option value="" data-fee="0">-- Escolha uma opção --</option>
                                <option value="Jardim Europa" data-fee="7.00">Jardim Europa (R$ 7,00)</option>
                                <option value="Amec" data-fee="7.00">Amec (R$ 7,00)</option>
                                <option value="Vale dos Sonhos 1 e 2" data-fee="8.00">Vale dos Sonhos 1 e 2 (R$ 8,00)</option>
                                <option value="Jardim do Lago" data-fee="8.00">Jardim do Lago (R$ 8,00)</option>
                                <option value="Casas Populares" data-fee="9.00">Casas Populares (R$ 9,00)</option>
                                <option value="Nova Esperança 2" data-fee="9.00">Nova Esperança 2 (R$ 9,00)</option>
                                <option value="Outro Bairro" data-fee="6.00">Outro Bairro (Taxa Padrão R$ 6,00)</option>
                            </select>
                        </div>
                        <div>
                            <label for="customer-address" class="block text-sm font-medium text-gray-400">Endereço Completo (Rua, Número, Complemento)</label>
                            <input type="text" id="customer-address" class="mt-1 block w-full bg-gray-700 border-2 border-gray-600 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 p-3 text-base" placeholder="Ex: Rua das Flores, 123, apt 4" required>
                        </div>
                    </div>
                     <div>
                        <label for="payment-method" class="block text-sm font-medium text-gray-400">Forma de Pagamento</label>
                        <select id="payment-method" class="mt-1 block w-full bg-gray-700 border-2 border-gray-600 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 p-3 text-base">
                            <option>Pix</option>
                            <option>Cartão de Crédito (na entrega)</option>
                            <option>Cartão de Débito (na entrega)</option>
                            <option>Dinheiro</option>
                        </select>
                        <p class="text-xs text-yellow-400 mt-2"><i class="fas fa-info-circle mr-1"></i>Observação: não aceitamos VR e vales refeição no momento.</p>
                    </div>
                     <div>
                        <label for="observations" class="block text-sm font-medium text-gray-400">Observações</label>
                        <textarea id="observations" rows="3" class="mt-1 block w-full bg-gray-700 border-2 border-gray-600 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 p-3 text-base" placeholder="Ex: Troco para R$50, sem cebola, etc."></textarea>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-gray-900 border-t border-gray-700 flex justify-between items-center">
                 <div>
                    <span class="text-lg font-medium text-gray-300">Total do Pedido:</span>
                    <span id="cart-total" class="text-2xl font-bold text-purple-400 ml-2">R$ 0,00</span>
                </div>
                <button onclick="finalizeOrder()" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-all flex items-center gap-2">
                    <i class="fab fa-whatsapp"></i> Finalizar Pedido
                </button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center p-4">
        <div class="bg-gray-800 text-gray-200 rounded-2xl shadow-2xl w-full max-w-lg text-center p-8">
            <div id="confirmation-icon"><i class="fas fa-check-circle text-green-500 text-6xl mb-4"></i></div>
            <h3 id="confirmation-title" class="text-2xl font-bold text-gray-100 mb-2">Pedido Recebido!</h3>
            <p id="confirmation-message" class="text-gray-400 mb-6">Seu resumo está pronto. Clique no botão para enviar via WhatsApp e concluir seu pedido!</p>
            <div id="order-summary" class="text-left bg-gray-700 p-4 rounded-lg mb-6 max-h-60 overflow-y-auto modal-body"></div>
            <div id="initial-confirm-buttons" class="flex flex-col sm:flex-row gap-4 justify-center">
                 <button onclick="sendOrderViaWhatsApp()" class="w-full bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition-all flex items-center justify-center gap-2">
                    <i class="fab fa-whatsapp"></i> Enviar Pedido
                </button>
                <button onclick="closeConfirmationModal()" class="w-full bg-gray-600 text-gray-100 font-bold py-3 px-6 rounded-lg hover:bg-gray-500 transition-all">Fechar</button>
            </div>
            <div id="post-send-buttons" class="hidden flex-col gap-4 justify-center">
                 <p class="text-sm text-yellow-400 mb-4">Após enviar a mensagem no WhatsApp, confirme abaixo para limpar seu carrinho.</p>
                 <button onclick="confirmOrderSent()" class="w-full bg-teal-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-teal-600 transition-all flex items-center justify-center gap-2">
                    <i class="fas fa-check-square"></i> Pedido Enviado, Limpar Carrinho
                </button>
                <button onclick="closeConfirmationModal()" class="w-full bg-gray-600 text-gray-100 font-bold py-3 px-6 rounded-lg hover:bg-gray-500 transition-all">Manter Carrinho e Fechar</button>
            </div>
        </div>
    </div>
    
    <!-- Custom Alert Modal -->
    <div id="alert-modal" class="alert-modal fixed inset-0 bg-black bg-opacity-60 z-[60] hidden items-center justify-center p-4 opacity-0">
        <div class="bg-gray-800 text-gray-200 rounded-2xl shadow-2xl w-full max-w-sm text-center p-6 transform scale-95 transition-transform">
            <div id="alert-icon" class="mx-auto mb-4"></div>
            <h3 id="alert-title" class="text-xl font-bold text-gray-100 mb-2">Atenção!</h3>
            <p id="alert-message" class="text-gray-400 mb-6">Mensagem de alerta.</p>
            <button onclick="closeAlertModal()" class="w-full bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700 transition-all">OK</button>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div id="admin-modal" class="fixed inset-0 bg-black bg-opacity-80 z-[70] hidden items-center justify-center p-4">
        <div class="bg-gray-800 text-gray-200 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-2xl font-bold text-amber-400"><i class="fas fa-user-shield mr-2"></i>Painel do Administrador</h3>
                <button onclick="closeAdminModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <div id="admin-body" class="p-6 space-y-6 overflow-y-auto modal-body">
                <!-- Admin content will be dynamically injected here -->
            </div>
            <div class="p-4 bg-gray-900 border-t border-gray-700 flex flex-wrap justify-between items-center gap-4">
                <button onclick="saveAdminChanges()" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition-all flex items-center gap-2">
                    <i class="fas fa-save"></i> Salvar Alterações
                </button>
                <button onclick="resetToDefaults()" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-all flex items-center gap-2 text-sm">
                    <i class="fas fa-undo"></i> Restaurar Padrão
                </button>
            </div>
        </div>
    </div>

    <!-- Password Prompt Modal -->
    <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-70 z-[80] hidden items-center justify-center p-4">
        <div class="bg-gray-800 text-gray-200 rounded-2xl shadow-2xl w-full max-w-sm text-center p-6">
            <h3 class="text-xl font-bold text-amber-400 mb-4">Acesso Restrito</h3>
            <p class="text-gray-400 mb-4">Por favor, insira o e-mail e a senha de administrador.</p>
            <input type="email" id="admin-email-input" class="block w-full bg-gray-700 border-2 border-gray-600 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 p-3 text-base mb-3" placeholder="E-mail">
            <input type="password" id="admin-password-input" class="block w-full bg-gray-700 border-2 border-gray-600 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 p-3 text-base" placeholder="Senha">
            <div class="mt-6 flex gap-4">
                <button onclick="closePasswordModal()" class="w-full bg-gray-600 text-gray-100 font-bold py-2 px-6 rounded-lg hover:bg-gray-500 transition-all">Cancelar</button>
                <button onclick="checkAdminPassword()" class="w-full bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700 transition-all">Entrar</button>
            </div>
        </div>
    </div>

    <!-- Generic Confirmation Modal -->
    <div id="confirm-action-modal" class="fixed inset-0 bg-black bg-opacity-70 z-[80] hidden items-center justify-center p-4">
        <div class="bg-gray-800 text-gray-200 rounded-2xl shadow-2xl w-full max-w-sm text-center p-6">
            <div id="confirm-action-icon" class="mx-auto mb-4"><i class="fas fa-exclamation-triangle text-yellow-500 text-5xl"></i></div>
            <h3 id="confirm-action-title" class="text-xl font-bold text-gray-100 mb-2">Confirmar Ação</h3>
            <p id="confirm-action-message" class="text-gray-400 mb-6">Você tem certeza?</p>
            <div class="mt-6 flex gap-4">
                <button id="confirm-action-cancel-btn" class="w-full bg-gray-600 text-gray-100 font-bold py-2 px-6 rounded-lg hover:bg-gray-500 transition-all">Cancelar</button>
                <button id="confirm-action-confirm-btn" class="w-full bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition-all">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        // =================================================================================
        // COLE A CONFIGURAÇÃO DO SEU PROJETO FIREBASE AQUI
        // =================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDSIIJm5q3RbLEZsNzeFo0T6Y_mtdLKd7U",
            authDomain: "sabor-acaiteria-oline.firebaseapp.com",
            projectId: "sabor-acaiteria-oline",
            storageBucket: "sabor-acaiteria-oline.appspot.com",
            messagingSenderId: "846562505902",
            appId: "1:846562505902:web:2fb8bc72e72b457b95e93f",
            measurementId: "G-DQ2M7J620Z"
        };
        // =================================================================================

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Pass Firebase services to the global scope so your existing script can use them
        window.db = db;
        window.auth = auth;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.onSnapshot = onSnapshot;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.onAuthStateChanged = onAuthStateChanged;

        // Trigger the initialization of the app's main logic
        window.initializeApp();
    </script>
    
    <script>
    // --- APPLICATION STATE ---
    let cart = [];
    let currentItem = null;
    let whatsAppMessage = '';
    let isStoreOpen = false;
    let adminSettings = {
        storeStatus: 'auto', // 'auto', 'open', 'closed'
        deliveryMode: 'both',  // 'both', 'delivery', 'takeout'
        openingTime: '14:30',
        closingTime: '22:15',
        openDays: [0, 1, 2, 3, 4, 5, 6] // Sun, Mon, Tue, Wed, Thu, Fri, Sat
    };
    let products = [];
    let toppings = {};
    let isAdmin = false;

    const CART_STORAGE_KEY = 'saborAcaiteriaCart';
    const CUSTOMER_INFO_STORAGE_KEY = 'saborAcaiteriaCustomerInfo';

    // --- DOM ELEMENT SELECTORS ---
    const productList = document.getElementById('product-list');
    const itemModal = document.getElementById('item-modal');
    const cartModal = document.getElementById('cart-modal');
    const confirmationModal = document.getElementById('confirmation-modal');
    const adminModal = document.getElementById('admin-modal');
    const cartButton = document.getElementById('cart-button');
    const alertModal = document.getElementById('alert-modal');
    const customerNameInput = document.getElementById('customer-name');
    const customerAddressInput = document.getElementById('customer-address');
    const neighborhoodSelect = document.getElementById('neighborhood');
    const deliveryFields = document.getElementById('delivery-fields');
    const deliveryOptionRadios = document.querySelectorAll('input[name="delivery_option"]');
    const passwordModal = document.getElementById('password-modal');
    const adminEmailInput = document.getElementById('admin-email-input');
    const adminPasswordInput = document.getElementById('admin-password-input');
    const confirmActionModal = document.getElementById('confirm-action-modal');

    // --- HELPER FUNCTIONS ---
    function formatCurrency(value) {
        return `R$ ${value.toFixed(2).replace('.', ',')}`;
    }

    // --- LOCAL STORAGE FUNCTIONS (FOR CART AND CUSTOMER INFO ONLY) ---
    function saveCart() { localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cart)); }
    function loadCart() {
        const savedCart = localStorage.getItem(CART_STORAGE_KEY);
        if (savedCart) cart = JSON.parse(savedCart);
    }
    function saveCustomerInfo() {
        const info = {
            name: customerNameInput.value,
            address: customerAddressInput.value,
            neighborhood: neighborhoodSelect.value,
            deliveryOption: document.querySelector('input[name="delivery_option"]:checked')?.value
        };
        localStorage.setItem(CUSTOMER_INFO_STORAGE_KEY, JSON.stringify(info));
    }
    function loadCustomerInfo() {
        const savedInfo = localStorage.getItem(CUSTOMER_INFO_STORAGE_KEY);
        if (savedInfo) {
            const info = JSON.parse(savedInfo);
            customerNameInput.value = info.name || '';
            customerAddressInput.value = info.address || '';
            neighborhoodSelect.value = info.neighborhood || '';
            if (info.deliveryOption) {
                const radio = document.querySelector(`input[name="delivery_option"][value="${info.deliveryOption}"]`);
                if (radio) radio.checked = true;
            }
        }
    }

    // --- FIREBASE FUNCTIONS ---
    async function loadDataFromFirebase() {
        const menuRef = doc(db, "menu", "main");
        const settingsRef = doc(db, "settings", "store");

        // Use onSnapshot for real-time updates
        onSnapshot(menuRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                products = data.products || [];
                toppings = data.toppings || {};
                renderProducts();
                checkStoreStatus();
            } else {
                console.log("No menu document! Using local defaults.");
                // Optionally, create a default document if it doesn't exist
            }
        });

        onSnapshot(settingsRef, (docSnap) => {
            if (docSnap.exists()) {
                adminSettings = Object.assign({}, adminSettings, docSnap.data());
                checkStoreStatus();
                renderDeliveryOptions();
            } else {
                console.log("No settings document! Using local defaults.");
            }
        });
    }

    async function saveAdminChanges() {
        if (!isAdmin) {
            showAlert("Você não tem permissão para salvar.", "Acesso Negado", true);
            return;
        }

        // Save settings
        const newAdminSettings = {
            storeStatus: document.querySelector('input[name="admin_store_status"]:checked').value,
            deliveryMode: document.querySelector('input[name="admin_delivery_mode"]:checked').value,
            openingTime: document.getElementById('admin-opening-time').value,
            closingTime: document.getElementById('admin-closing-time').value,
            openDays: Array.from(document.querySelectorAll('input[name="admin_open_day"]:checked')).map(cb => parseInt(cb.value))
        };
        
        // Save menu
        const newProducts = [];
        document.querySelectorAll('#admin-products-list .admin-item').forEach((item, index) => {
            const name = item.querySelector('.admin-name').value;
            const price = parseFloat(item.querySelector('.admin-price').value);
            const disabled = item.querySelector('.admin-disabled').checked;
            if (name && !isNaN(price)) {
                newProducts.push({ id: Date.now() + index, name, price, disabled });
            }
        });
        
        const newToppings = {};
        Object.keys(toppings).forEach(key => {
            const categoryItems = [];
            document.querySelectorAll(`#admin-toppings-${key} .admin-item`).forEach(item => {
                const name = item.querySelector('.admin-name').value;
                const disabled = item.querySelector('.admin-disabled').checked;
                if (name) {
                    categoryItems.push({ name, disabled });
                }
            });
            newToppings[key] = { ...toppings[key], items: categoryItems };
        });

        try {
            await setDoc(doc(db, "settings", "store"), newAdminSettings);
            await setDoc(doc(db, "menu", "main"), { products: newProducts, toppings: newToppings });
            showAlert('Configurações salvas com sucesso!', 'Salvo!', false);
            closeAdminModal();
        } catch (error) {
            console.error("Error writing document: ", error);
            showAlert("Erro ao salvar as configurações. Verifique o console.", "Erro", true);
        }
    }

    // --- CUSTOM ALERT FUNCTION ---
    function showAlert(message, title = 'Atenção!', isError = false) {
        document.getElementById('alert-message').textContent = message;
        document.getElementById('alert-title').textContent = title;
        const iconContainer = document.getElementById('alert-icon');
        if (isError) {
            iconContainer.innerHTML = '<i class="fas fa-exclamation-triangle text-red-500 text-5xl"></i>';
        } else {
            iconContainer.innerHTML = '<i class="fas fa-check-circle text-green-500 text-5xl"></i>';
        }
        alertModal.classList.remove('hidden');
        setTimeout(() => {
            alertModal.classList.remove('opacity-0');
            alertModal.querySelector('div > div').classList.remove('scale-95');
        }, 10);
    }
    function closeAlertModal() {
        alertModal.classList.add('opacity-0');
        alertModal.querySelector('div > div').classList.add('scale-95');
        setTimeout(() => { alertModal.classList.add('hidden'); }, 300);
    }

    // --- STORE STATUS LOGIC ---
    function renderStoreHoursDisplay() {
        const display = document.getElementById('store-hours-display');
        const dayNames = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"];
        let daysString = "Fechado todos os dias";

        if (adminSettings.openDays.length > 0) {
            if (adminSettings.openDays.length === 7) {
                daysString = "Todos os dias";
            } else {
                daysString = adminSettings.openDays.sort().map(dayIndex => dayNames[dayIndex]).join(', ');
            }
        }
        
        display.querySelector('span').textContent = `${adminSettings.openingTime} às ${adminSettings.closingTime} (${daysString})`;
    }

    function checkStoreStatus() {
        const indicator = document.getElementById('store-status-indicator');
        const banner = document.getElementById('store-status-banner');
        const finalizeBtn = document.querySelector('button[onclick="finalizeOrder()"]');

        if (adminSettings.storeStatus === 'open') {
            isStoreOpen = true;
        } else if (adminSettings.storeStatus === 'closed') {
            isStoreOpen = false;
        } else { // 'auto'
            const now = new Date();
            const currentDay = now.getDay(); // Sunday = 0, Monday = 1, etc.
            const isTodayOpenDay = adminSettings.openDays.includes(currentDay);

            if (!isTodayOpenDay) {
                isStoreOpen = false;
            } else {
                const openTime = parseInt(adminSettings.openingTime.replace(':', ''));
                const closeTime = parseInt(adminSettings.closingTime.replace(':', ''));
                const currentTime = now.getHours() * 100 + now.getMinutes();
                isStoreOpen = (currentTime >= openTime && currentTime <= closeTime);
            }
        }

        if (isStoreOpen) {
            indicator.textContent = 'Aberto';
            indicator.className = 'ml-2 px-3 py-1 text-sm rounded-full bg-green-500 text-white font-bold';
            banner.innerHTML = '';
            banner.classList.add('hidden');
            if (finalizeBtn) {
                finalizeBtn.disabled = false;
                finalizeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        } else {
            indicator.textContent = 'Fechado';
            indicator.className = 'ml-2 px-3 py-1 text-sm rounded-full bg-red-500 text-white font-bold';
            banner.innerHTML = `
                <div class="bg-red-900/50 border-l-4 border-red-500 text-red-300 p-4 rounded-md mb-8 text-center" role="alert">
                    <p class="font-bold text-lg">No momento estamos fechados!</p>
                    <p class="text-sm">Você pode navegar pelo cardápio, mas os pedidos estão suspensos.</p>
                </div>
            `;
            banner.classList.remove('hidden');
            
            document.querySelectorAll('#product-list button').forEach(btn => {
                btn.disabled = true;
                btn.textContent = 'Fechado';
                btn.classList.add('cursor-not-allowed', 'bg-gray-600');
                btn.classList.remove('bg-purple-600', 'hover:bg-purple-500');
            });
            
            if (finalizeBtn) {
                finalizeBtn.disabled = true;
                finalizeBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }
        renderStoreHoursDisplay();
    }


    // --- RENDER FUNCTIONS ---
    function renderProducts() {
        productList.innerHTML = '';
        products.forEach(product => {
            if (product.disabled) return; 
            const productCard = `
                <div class="bg-gray-800 border border-gray-700 rounded-xl p-4 text-center transition-all hover:shadow-lg hover:border-purple-400 cursor-pointer flex flex-col justify-between" onclick="openItemModal(${product.id})">
                    <div>
                        <h3 class="font-bold text-xl text-gray-100">${product.name}</h3>
                        <p class="text-2xl font-semibold text-purple-400 mt-2">${formatCurrency(product.price)}</p>
                    </div>
                    <button class="mt-4 bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-500 transition-all w-full">Montar</button>
                </div>
            `;
            productList.innerHTML += productCard;
        });
        checkStoreStatus(); // Re-check status after rendering products
    }

    function renderCart() {
        const cartContainer = document.getElementById('cart-items-container');
        const cartTotalEl = document.getElementById('cart-total');
        const cartCountEl = document.getElementById('cart-count');
        const checkoutForm = document.getElementById('checkout-form');
        const summaryDetails = document.getElementById('cart-summary-details');

        if (cart.length === 0) {
            cartContainer.innerHTML = '<p class="text-gray-500 text-center">Seu carrinho está vazio.</p>';
            checkoutForm.classList.add('hidden');
            summaryDetails.classList.add('hidden');
        } else {
            checkoutForm.classList.remove('hidden');
            summaryDetails.classList.remove('hidden');
            cartContainer.innerHTML = cart.map((item, index) => `
                <div class="flex items-start justify-between p-4 border-b border-gray-700">
                    <div>
                        <p class="font-bold text-lg text-gray-100">${item.name} (x${item.quantity})</p>
                        <div class="text-sm text-gray-400 pl-2 mt-1">
                            ${item.toppings.length > 0 ? item.toppings.map(t => `<span>- ${t.name} ${t.price > 0 ? `(+ ${formatCurrency(t.price)})` : ''}</span>`).join('<br>') : '<span>- Açaí puro</span>'}
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-lg text-purple-400">${formatCurrency(item.price * item.quantity)}</p>
                        <div class="flex items-center gap-2 mt-2">
                            <button onclick="updateQuantity(${index}, -1)" class="bg-gray-700 w-7 h-7 rounded-full font-bold text-lg flex items-center justify-center">-</button>
                            <span class="font-bold w-5 text-center">${item.quantity}</span>
                            <button onclick="updateQuantity(${index}, 1)" class="bg-gray-700 w-7 h-7 rounded-full font-bold text-lg flex items-center justify-center">+</button>
                            <button onclick="removeFromCart(${index})" class="text-red-500 hover:text-red-700 ml-2"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const deliveryOption = document.querySelector('input[name="delivery_option"]:checked')?.value;
        
        let deliveryFee = 0;
        if (deliveryOption === 'delivery' && subtotal > 0) {
            const selectedOption = neighborhoodSelect.options[neighborhoodSelect.selectedIndex];
            deliveryFee = parseFloat(selectedOption.dataset.fee || 0);
        }
        
        const finalTotal = subtotal + deliveryFee;

        document.getElementById('cart-subtotal').textContent = formatCurrency(subtotal);
        document.getElementById('cart-delivery-fee').textContent = formatCurrency(deliveryFee);
        cartTotalEl.textContent = formatCurrency(finalTotal);
        cartCountEl.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
    }

    // --- DELIVERY OPTION LOGIC ---
    function renderDeliveryOptions() {
        const deliveryLabel = document.getElementById('delivery-option-delivery');
        const takeoutLabel = document.getElementById('delivery-option-takeout');
        const deliveryRadio = deliveryLabel.querySelector('input');
        const takeoutRadio = takeoutLabel.querySelector('input');
        const deliveryOptionsContainer = document.getElementById('delivery-options');

        deliveryLabel.classList.add('hidden');
        takeoutLabel.classList.add('hidden');

        let activeOptions = 0;

        if (adminSettings.deliveryMode === 'both' || adminSettings.deliveryMode === 'delivery') {
            deliveryLabel.classList.remove('hidden');
            activeOptions++;
        }
        if (adminSettings.deliveryMode === 'both' || adminSettings.deliveryMode === 'takeout') {
            takeoutLabel.classList.remove('hidden');
            activeOptions++;
        }

        if (activeOptions === 0) {
            deliveryOptionsContainer.classList.add('hidden');
        } else {
            deliveryOptionsContainer.classList.remove('hidden');
        }

        const currentSelected = document.querySelector('input[name="delivery_option"]:checked');
        if (!currentSelected || currentSelected.closest('label').classList.contains('hidden')) {
            if (!deliveryLabel.classList.contains('hidden')) {
                deliveryRadio.checked = true;
            } else if (!takeoutLabel.classList.contains('hidden')) {
                takeoutRadio.checked = true;
            }
        }
        
        toggleDeliveryFields();
    }

    function toggleDeliveryFields() {
        const deliveryOption = document.querySelector('input[name="delivery_option"]:checked')?.value;
        if (deliveryOption === 'takeout' || !deliveryOption) {
            deliveryFields.classList.add('hidden');
        } else {
            deliveryFields.classList.remove('hidden');
        }
        renderCart();
    }

    // --- MODAL LOGIC ---
    function openItemModal(productId) {
        if (!isStoreOpen) {
            showAlert('A loja está fechada e não é possível montar pedidos agora.', 'Loja Fechada', true);
            return;
        }
        const product = products.find(p => p.id === productId);
        if (!product) return;
        currentItem = {
            id: productId, name: product.name, basePrice: product.price, price: product.price, quantity: 1, toppings: [],
        };

        document.getElementById('modal-title').textContent = `Monte seu ${product.name}`;
        const modalBody = document.getElementById('modal-body');
        modalBody.innerHTML = '';

        const warningNote = `<div class="bg-yellow-900/50 border-l-4 border-yellow-500 text-yellow-300 p-4 rounded-md" role="alert"><div class="flex"><div class="py-1"><i class="fas fa-info-circle mr-3"></i></div><div><p class="font-bold">Atenção!</p><p class="text-sm">Escolha seus adicionais com carinho. Nossos copos têm espaço limitado e talvez não seja possível incluir todos os itens selecionados.</p></div></div></div>`;
        modalBody.innerHTML += warningNote;

        Object.entries(toppings).forEach(([key, category]) => {
            const section = document.createElement('div');
            let itemsHTML = category.items
                .filter(item => !item.disabled) // Filter out disabled items
                .map(item => `
                <label class="flex items-center space-x-3 p-2 rounded-md hover:bg-gray-700 cursor-pointer">
                    <input type="checkbox" class="h-5 w-5 rounded border-gray-500 bg-gray-600 text-purple-600 focus:ring-purple-500" name="${key}" value="${item.name}" data-price="${category.price || 0}">
                    <span class="text-gray-300">${item.name}</span>
                </label>
            `).join('');
            
            if (itemsHTML.length > 0) {
                section.innerHTML = `<h4 class="text-lg font-bold text-gray-200 mb-2 pb-1 border-b border-gray-600">${category.title}</h4><div class="grid grid-cols-2 sm:grid-cols-3 gap-2">${itemsHTML}</div>`;
                modalBody.appendChild(section);
            }
        });
        
        modalBody.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateModalItemTotal);
        });

        updateModalItemTotal();
        itemModal.classList.remove('hidden');
        itemModal.classList.add('flex');
    }

    function closeItemModal() {
        itemModal.classList.add('hidden');
        itemModal.classList.remove('flex');
        currentItem = null;
    }

    function updateModalItemTotal() {
        let totalFromToppings = 0;
        const currentToppingsList = [];

        Object.entries(toppings).forEach(([key, category]) => {
            const checkboxes = document.querySelectorAll(`#modal-body input[name="${key}"]`);
            const checkedCheckboxes = document.querySelectorAll(`#modal-body input[name="${key}"]:checked`);

            if (category.limit) {
                if (checkedCheckboxes.length >= category.limit) {
                    checkboxes.forEach(cb => { if (!cb.checked) cb.disabled = true; });
                } else {
                    checkboxes.forEach(cb => { cb.disabled = false; });
                }
            }
            
            checkedCheckboxes.forEach(checkbox => {
                const price = parseFloat(checkbox.dataset.price);
                if (price > 0) totalFromToppings += price;
                currentToppingsList.push({ name: checkbox.value, price: price });
            });
        });
        
        currentItem.price = currentItem.basePrice + totalFromToppings;
        currentItem.toppings = currentToppingsList.sort((a, b) => a.price - b.price);
        document.getElementById('modal-item-total').textContent = formatCurrency(currentItem.price);
    }

    function toggleCartModal() {
        renderDeliveryOptions(); // Ensure options are up-to-date
        renderCart();
        cartModal.classList.toggle('hidden');
        cartModal.classList.toggle('flex');
    }

    function closeConfirmationModal() {
        confirmationModal.classList.add('hidden');
        confirmationModal.classList.remove('flex');
        setTimeout(() => {
            document.getElementById('confirmation-icon').innerHTML = '<i class="fas fa-check-circle text-green-500 text-6xl mb-4"></i>';
            document.getElementById('confirmation-title').textContent = 'Pedido Recebido!';
            document.getElementById('confirmation-message').textContent = 'Seu resumo está pronto. Clique no botão para enviar via WhatsApp e concluir seu pedido!';
            document.getElementById('initial-confirm-buttons').classList.remove('hidden');
            document.getElementById('initial-confirm-buttons').classList.add('flex');
            document.getElementById('post-send-buttons').classList.add('hidden');
            document.getElementById('post-send-buttons').classList.remove('flex');
        }, 300);
    }

    // --- CART LOGIC ---
    document.getElementById('add-to-cart-btn').addEventListener('click', () => {
        const existingItemIndex = cart.findIndex(item => {
            if (item.id !== currentItem.id || item.toppings.length !== currentItem.toppings.length) return false;
            const currentToppingsSet = new Set(currentItem.toppings.map(t => t.name));
            const existingToppingsSet = new Set(item.toppings.map(t => t.name));
            if (currentToppingsSet.size !== existingToppingsSet.size) return false;
            return [...currentToppingsSet].every(t => existingToppingsSet.has(t));
        });

        if (existingItemIndex > -1) {
            cart[existingItemIndex].quantity++;
        } else {
            cart.push({ ...currentItem });
        }
        
        saveCart();
        closeItemModal();
        renderCart();
        updateCartIcon();
    });

    function updateQuantity(index, change) {
        if (cart[index].quantity + change > 0) {
            cart[index].quantity += change;
        } else {
            removeFromCart(index);
            return;
        }
        saveCart();
        renderCart();
        updateCartIcon();
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        saveCart();
        renderCart();
        updateCartIcon();
    }

    function updateCartIcon() {
        const cartCountEl = document.getElementById('cart-count');
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        cartCountEl.textContent = totalItems;
        if (totalItems > 0) {
            cartButton.classList.remove('hidden');
        } else {
             cartButton.classList.add('hidden');
             if (cartModal.classList.contains('flex')) {
                 toggleCartModal();
             }
        }
    }

    // --- ORDER FINALIZATION LOGIC ---
    function finalizeOrder() {
        if (!isStoreOpen) {
            showAlert('A loja está fechada e não está aceitando pedidos no momento.', 'Loja Fechada', true);
            return;
        }

        if (cart.length === 0) {
            showAlert('Seu carrinho está vazio!', 'Carrinho Vazio', true);
            return;
        }
        const name = customerNameInput.value.trim();
        const address = customerAddressInput.value.trim();
        const neighborhood = neighborhoodSelect.value;
        const payment = document.getElementById('payment-method').value;
        const obs = document.getElementById('observations').value.trim();
        const deliveryOption = document.querySelector('input[name="delivery_option"]:checked')?.value;

        if (!deliveryOption) {
            showAlert('Nenhuma opção de entrega/retirada está disponível no momento.', 'Ops!', true);
            return;
        }

        if (!name) {
            showAlert('Por favor, preencha seu Nome para continuar.', 'Dados Incompletos', true);
            return;
        }
        
        let deliveryFee = 0;
        let summary = `*NOVO PEDIDO - SABOR AÇAÍTERIA*\n\n*Cliente:* ${name}\n`;

        if (deliveryOption === 'delivery') {
            if (!address || !neighborhood) {
                showAlert('Por favor, selecione o Bairro e preencha o Endereço para entrega.', 'Dados Incompletos', true);
                return;
            }
            summary += `*Opção:* ENTREGA\n*Tempo Estimado:* 20-60 min\n*Endereço:* ${address}, ${neighborhood}\n\n`;
            const selectedOption = neighborhoodSelect.options[neighborhoodSelect.selectedIndex];
            deliveryFee = parseFloat(selectedOption.dataset.fee || 0);
        } else {
            summary += `*Opção:* RETIRAR NA LOJA\n*Tempo Estimado:* 20-30 min\n\n`;
        }

        summary += `*ITENS DO PEDIDO:*\n------------------------\n`;
        cart.forEach(item => {
            summary += `*${item.quantity}x ${item.name}*\n`;
            if (item.toppings.length > 0) {
                item.toppings.forEach(t => { summary += `  - ${t.name}\n`; });
            } else {
                summary += `  - Açaí puro\n`;
            }
            summary += `Subtotal: ${formatCurrency(item.price * item.quantity)}\n------------------------\n`;
        });

        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const finalTotal = subtotal + deliveryFee;
        summary += `\n*Subtotal dos Itens: ${formatCurrency(subtotal)}*\n`;
        if (deliveryOption === 'delivery') summary += `*Taxa de Entrega: ${formatCurrency(deliveryFee)}*\n`;
        summary += `*TOTAL DO PEDIDO: ${formatCurrency(finalTotal)}*\n*Forma de Pagamento:* ${payment}\n`;
        if (obs) summary += `*Observações:* ${obs}\n`;

        whatsAppMessage = encodeURIComponent(summary);
        document.getElementById('order-summary').innerHTML = summary.replace(/\n/g, '<br>').replace(/\*(.*?)\*/g, '<strong>$1</strong>');
        toggleCartModal(); 
        confirmationModal.classList.remove('hidden');
        confirmationModal.classList.add('flex');
    }

    function sendOrderViaWhatsApp() {
        const yourNumber = '5594991623576'; 
        const url = `https://wa.me/${yourNumber}?text=${whatsAppMessage}`;
        window.open(url, '_blank');
        
        document.getElementById('confirmation-icon').innerHTML = '<i class="fab fa-whatsapp-square text-green-400 text-6xl mb-4"></i>';
        document.getElementById('confirmation-title').textContent = 'Quase lá!';
        document.getElementById('confirmation-message').textContent = 'A janela do WhatsApp foi aberta. Após enviar sua mensagem, clique no botão abaixo para confirmar e limpar seu carrinho.';
        document.getElementById('initial-confirm-buttons').classList.add('hidden');
        document.getElementById('post-send-buttons').classList.remove('hidden');
        document.getElementById('post-send-buttons').classList.add('flex');
    }

    function confirmOrderSent() {
        cart = [];
        saveCart();
        closeConfirmationModal();
        renderCart();
        updateCartIcon();
        showAlert('Ótimo! Seu carrinho foi limpo. Aguarde a confirmação da loja no WhatsApp.', 'Pedido Enviado');
    }

    // --- ADMIN PANEL LOGIC ---
    function openAdminPanel(event) {
        event.preventDefault();
        if (isAdmin) {
            renderAdminPanel();
            adminModal.classList.remove('hidden');
            adminModal.classList.add('flex');
        } else {
            passwordModal.classList.remove('hidden');
            passwordModal.classList.add('flex');
            adminEmailInput.focus();
        }
    }

    function closePasswordModal() {
        passwordModal.classList.add('hidden');
        passwordModal.classList.remove('flex');
        adminEmailInput.value = '';
        adminPasswordInput.value = '';
    }

    function checkAdminPassword() {
        const email = adminEmailInput.value;
        const password = adminPasswordInput.value;
        signInWithEmailAndPassword(auth, email, password)
            .then((userCredential) => {
                // Signed in 
                closePasswordModal();
                renderAdminPanel();
                adminModal.classList.remove('hidden');
                adminModal.classList.add('flex');
            })
            .catch((error) => {
                closePasswordModal();
                showAlert("E-mail ou senha incorretos.", 'Acesso Negado', true);
            });
    }

    function closeAdminModal() {
        adminModal.classList.add('hidden');
        adminModal.classList.remove('flex');
    }

    function renderAdminPanel() {
        const adminBody = document.getElementById('admin-body');
        adminBody.innerHTML = ''; // Clear previous content

        // Section for Store Settings
        const daysOfWeek = ["Domingo", "Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado"];
        let daysCheckboxesHTML = daysOfWeek.map((day, index) => `
            <label class="flex items-center gap-2 p-1.5 rounded-md hover:bg-gray-700 cursor-pointer">
                <input type="checkbox" name="admin_open_day" value="${index}" class="h-4 w-4 rounded text-purple-600 focus:ring-purple-500" ${adminSettings.openDays.includes(index) ? 'checked' : ''}>
                <span>${day}</span>
            </label>
        `).join('');

        let settingsHTML = `
            <div class="p-4 bg-gray-900/50 rounded-lg">
                <h4 class="text-xl font-bold text-purple-400 mb-4">Configurações da Loja</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <div>
                        <h5 class="font-semibold text-gray-300 mb-2">Status da Loja</h5>
                        <div class="space-y-2">
                            <label class="flex items-center p-2 rounded-md hover:bg-gray-700 cursor-pointer"><input type="radio" name="admin_store_status" value="auto" class="h-4 w-4 mr-2 text-purple-600 focus:ring-purple-500" ${adminSettings.storeStatus === 'auto' ? 'checked' : ''}> Automático (por horário)</label>
                            <label class="flex items-center p-2 rounded-md hover:bg-gray-700 cursor-pointer"><input type="radio" name="admin_store_status" value="open" class="h-4 w-4 mr-2 text-purple-600 focus:ring-purple-500" ${adminSettings.storeStatus === 'open' ? 'checked' : ''}> Aberto (Manual)</label>
                            <label class="flex items-center p-2 rounded-md hover:bg-gray-700 cursor-pointer"><input type="radio" name="admin_store_status" value="closed" class="h-4 w-4 mr-2 text-purple-600 focus:ring-purple-500" ${adminSettings.storeStatus === 'closed' ? 'checked' : ''}> Fechado (Manual)</label>
                        </div>
                    </div>
                    <div>
                        <h5 class="font-semibold text-gray-300 mb-2">Opções de Pedido</h5>
                         <div class="space-y-2">
                            <label class="flex items-center p-2 rounded-md hover:bg-gray-700 cursor-pointer"><input type="radio" name="admin_delivery_mode" value="both" class="h-4 w-4 mr-2 text-purple-600 focus:ring-purple-500" ${adminSettings.deliveryMode === 'both' ? 'checked' : ''}> Delivery e Retirada</label>
                            <label class="flex items-center p-2 rounded-md hover:bg-gray-700 cursor-pointer"><input type="radio" name="admin_delivery_mode" value="delivery" class="h-4 w-4 mr-2 text-purple-600 focus:ring-purple-500" ${adminSettings.deliveryMode === 'delivery' ? 'checked' : ''}> Apenas Delivery</label>
                            <label class="flex items-center p-2 rounded-md hover:bg-gray-700 cursor-pointer"><input type="radio" name="admin_delivery_mode" value="takeout" class="h-4 w-4 mr-2 text-purple-600 focus:ring-purple-500" ${adminSettings.deliveryMode === 'takeout' ? 'checked' : ''}> Apenas Retirada</label>
                        </div>
                    </div>
                    <div class="md:col-span-2">
                         <h5 class="font-semibold text-gray-300 mb-2">Horário de Funcionamento (Modo Automático)</h5>
                         <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div class="sm:col-span-2">
                                <h6 class="text-sm font-medium text-gray-400 mb-1">Dias da Semana</h6>
                                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-x-4 gap-y-2 text-sm">
                                    ${daysCheckboxesHTML}
                                </div>
                            </div>
                            <div>
                                <h6 class="text-sm font-medium text-gray-400 mb-1">Horário</h6>
                                <div class="flex items-center gap-2">
                                    <input type="time" id="admin-opening-time" value="${adminSettings.openingTime}" class="bg-gray-700 p-2 rounded-md border border-gray-600 w-full">
                                    <span>às</span>
                                    <input type="time" id="admin-closing-time" value="${adminSettings.closingTime}" class="bg-gray-700 p-2 rounded-md border border-gray-600 w-full">
                                </div>
                            </div>
                         </div>
                    </div>
                </div>
            </div>
        `;
        adminBody.innerHTML += settingsHTML;

        // Section for Products (Tamanhos)
        let productsHTML = `<div class="p-4 bg-gray-900/50 rounded-lg"><h4 class="text-xl font-bold text-purple-400 mb-4">Tamanhos (Produtos)</h4><div id="admin-products-list" class="space-y-3">`;
        products.forEach((product, index) => {
            productsHTML += `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-center p-2 bg-gray-700 rounded-md admin-item" data-type="product" data-index="${index}">
                    <input type="text" value="${product.name}" class="admin-name col-span-2 bg-gray-600 p-2 rounded-md border border-gray-500" placeholder="Nome do Produto">
                    <input type="number" value="${product.price.toFixed(2)}" class="admin-price bg-gray-600 p-2 rounded-md border border-gray-500" placeholder="Preço">
                    <div class="flex items-center justify-between gap-2">
                        <label class="flex items-center gap-2 text-sm cursor-pointer"><input type="checkbox" class="admin-disabled h-5 w-5" ${product.disabled ? 'checked' : ''}> Bloquear</label>
                        <button onclick="removeAdminItem(this)" class="text-red-500 hover:text-red-400"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>`;
        });
        productsHTML += `</div><button onclick="addAdminItem('product')" class="mt-4 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-500 text-sm"><i class="fas fa-plus mr-2"></i>Adicionar Tamanho</button></div>`;
        adminBody.innerHTML += productsHTML;

        // Section for Toppings
        let toppingsHTML = `<div class="p-4 bg-gray-900/50 rounded-lg mt-6"><h4 class="text-xl font-bold text-purple-400 mb-4">Complementos</h4>`;
        Object.entries(toppings).forEach(([key, category]) => {
            toppingsHTML += `<div class="mt-4"><h5 class="font-semibold text-gray-300 mb-2">${category.title}</h5><div id="admin-toppings-${key}" class="space-y-2">`;
            (category.items || []).forEach((item, index) => {
                toppingsHTML += `
                    <div class="flex items-center gap-3 p-2 bg-gray-700 rounded-md admin-item" data-type="topping" data-category="${key}" data-index="${index}">
                        <input type="text" value="${item.name}" class="admin-name flex-grow bg-gray-600 p-2 rounded-md border border-gray-500" placeholder="Nome do Complemento">
                        <label class="flex items-center gap-2 text-sm cursor-pointer whitespace-nowrap"><input type="checkbox" class="admin-disabled h-5 w-5" ${item.disabled ? 'checked' : ''}> Bloquear</label>
                        <button onclick="removeAdminItem(this)" class="text-red-500 hover:text-red-400"><i class="fas fa-trash-alt"></i></button>
                    </div>`;
            });
            toppingsHTML += `</div><button onclick="addAdminItem('topping', '${key}')" class="mt-3 bg-blue-600 text-white font-semibold py-1 px-3 rounded-lg hover:bg-blue-500 text-xs"><i class="fas fa-plus mr-1"></i>Adicionar Complemento</button></div>`;
        });
        toppingsHTML += `</div>`;
        adminBody.innerHTML += toppingsHTML;
    }

    function addAdminItem(type, categoryKey = '') {
        const newItemHTML = (type === 'product')
            ? `<div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-center p-2 bg-gray-700 rounded-md admin-item" data-type="product">
                   <input type="text" value="Novo Produto" class="admin-name col-span-2 bg-gray-600 p-2 rounded-md border border-gray-500">
                   <input type="number" value="0.00" class="admin-price bg-gray-600 p-2 rounded-md border border-gray-500">
                   <div class="flex items-center justify-between gap-2">
                       <label class="flex items-center gap-2 text-sm cursor-pointer"><input type="checkbox" class="admin-disabled h-5 w-5"> Bloquear</label>
                       <button onclick="removeAdminItem(this)" class="text-red-500 hover:text-red-400"><i class="fas fa-trash-alt"></i></button>
                   </div>
               </div>`
            : `<div class="flex items-center gap-3 p-2 bg-gray-700 rounded-md admin-item" data-type="topping" data-category="${categoryKey}">
                   <input type="text" value="Novo Complemento" class="admin-name flex-grow bg-gray-600 p-2 rounded-md border border-gray-500">
                   <label class="flex items-center gap-2 text-sm cursor-pointer whitespace-nowrap"><input type="checkbox" class="admin-disabled h-5 w-5"> Bloquear</label>
                   <button onclick="removeAdminItem(this)" class="text-red-500 hover:text-red-400"><i class="fas fa-trash-alt"></i></button>
               </div>`;
        
        const containerId = (type === 'product') ? 'admin-products-list' : `admin-toppings-${categoryKey}`;
        document.getElementById(containerId).insertAdjacentHTML('beforeend', newItemHTML);
    }

    function removeAdminItem(button) {
        button.closest('.admin-item').remove();
    }

    function showConfirmationModal(message, onConfirm) {
        document.getElementById('confirm-action-message').textContent = message;
        
        const confirmBtn = document.getElementById('confirm-action-confirm-btn');
        const cancelBtn = document.getElementById('confirm-action-cancel-btn');

        const confirmClickHandler = () => {
            onConfirm();
            closeConfirmationActionModal();
        };

        const cancelClickHandler = () => {
            closeConfirmationActionModal();
        };

        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.addEventListener('click', confirmClickHandler, { once: true });

        const newCancelBtn = cancelBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        newCancelBtn.addEventListener('click', cancelClickHandler, { once: true });

        confirmActionModal.classList.remove('hidden');
        confirmActionModal.classList.add('flex');
    }

    function closeConfirmationActionModal() {
        confirmActionModal.classList.add('hidden');
        confirmActionModal.classList.remove('flex');
    }

    async function resetToDefaults() {
        if (!isAdmin) {
            showAlert("Você não tem permissão para esta ação.", "Acesso Negado", true);
            return;
        }
        showConfirmationModal(
            "Tem certeza que deseja restaurar o cardápio e as configurações para os valores padrão? Todas as suas alterações serão perdidas.",
            async () => {
                const defaultSettings = {
                    storeStatus: 'auto', deliveryMode: 'both', openingTime: '14:30', closingTime: '22:15', openDays: [0, 1, 2, 3, 4, 5, 6]
                };
                const defaultProducts = [
                    { id: 1, name: 'Copo 300ml', price: 14.00, disabled: false }, { id: 2, name: 'Copo 400ml', price: 17.00, disabled: false },
                    { id: 3, name: 'Copo 500ml', price: 20.00, disabled: false }, { id: 4, name: 'Barca M', price: 55.00, disabled: true }
                ];
                const defaultToppings = { /* ... seu objeto de toppings padrão aqui ... */ };

                try {
                    await setDoc(doc(db, "settings", "store"), defaultSettings);
                    await setDoc(doc(db, "menu", "main"), { products: defaultProducts, toppings: defaultToppings });
                    closeAdminModal();
                    showAlert('Cardápio e configurações restaurados!', 'Sucesso', false);
                } catch (error) {
                    showAlert("Erro ao restaurar. Verifique o console.", "Erro", true);
                }
            }
        );
    }

    // --- INITIALIZATION ---
    window.initializeApp = () => {
        // This function is called after Firebase scripts are loaded
        onAuthStateChanged(auth, user => {
            isAdmin = !!user;
        });

        loadDataFromFirebase();
        loadCart();
        loadCustomerInfo();
        updateCartIcon();

        // Event listeners
        customerNameInput.addEventListener('input', saveCustomerInfo);
        customerAddressInput.addEventListener('input', saveCustomerInfo);
        neighborhoodSelect.addEventListener('change', () => {
            saveCustomerInfo();
            renderCart();
        });
        deliveryOptionRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                toggleDeliveryFields();
                saveCustomerInfo();
            });
        });
        
        adminPasswordInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                checkAdminPassword();
            }
        });
        adminEmailInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                adminPasswordInput.focus();
            }
        });
    };

    // Make functions available in the global scope so inline onclicks can find them
    window.openAdminPanel = openAdminPanel;
    window.closePasswordModal = closePasswordModal;
    window.checkAdminPassword = checkAdminPassword;
    window.closeAdminModal = closeAdminModal;
    window.saveAdminChanges = saveAdminChanges;
    window.resetToDefaults = resetToDefaults;
    window.addAdminItem = addAdminItem;
    window.removeAdminItem = removeAdminItem;
    window.openItemModal = openItemModal;
    window.closeItemModal = closeItemModal;
    window.toggleCartModal = toggleCartModal;
    window.updateQuantity = updateQuantity;
    window.removeFromCart = removeFromCart;
    window.finalizeOrder = finalizeOrder;
    window.sendOrderViaWhatsApp = sendOrderViaWhatsApp;
    window.confirmOrderSent = confirmOrderSent;
    window.closeConfirmationModal = closeConfirmationModal;
    window.closeAlertModal = closeAlertModal;

    </script>
</body>
</html>

